<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Удобство 58 - Премиальная мебель</title>
  
  <!-- Внешние стили -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/coloris/0.20.0/coloris.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ====== ПЕРЕМЕННЫЕ ДЛЯ ТЕМ ====== */
    :root {
      --primary: #1a365d;
      --primary-dark: #0d243f;
      --primary-light: #2d4a8a;
      --secondary: #b8860b;
      --secondary-dark: #8b6508;
      --accent: #2c5282;
      --light: #f7fafc;
      --light-gray: #e2e8f0;
      --gray: #718096;
      --dark: #2d3748;
      --dark-gray: #4a5568;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --info: #3182ce;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
      --radius: 6px;
      --radius-lg: 10px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --header-height: 70px;
      --sidebar-width: 400px;
      --container-width: 1400px;
      
      /* Цвета темы */
      --bg-color: #f5f7fa;
      --surface-color: #ffffff;
      --text-color: #2d3748;
      --text-secondary: #4a5568;
      --border-color: #e2e8f0;
    }

    /* Темная тема */
    body.dark-theme {
      --primary: #63b3ed;
      --primary-dark: #4299e1;
      --primary-light: #90cdf4;
      --secondary: #ecc94b;
      --secondary-dark: #d69e2e;
      --accent: #4fd1c7;
      --light: #2d3748;
      --light-gray: #4a5568;
      --gray: #a0aec0;
      --dark: #f7fafc;
      --dark-gray: #e2e8f0;
      --success: #68d391;
      --warning: #f6ad55;
      --danger: #fc8181;
      --info: #76c9f4;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
      
      --bg-color: #1a202c;
      --surface-color: #2d3748;
      --text-color: #f7fafc;
      --text-secondary: #e2e8f0;
      --border-color: #4a5568;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* ====== ТИПОГРАФИЯ ====== */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 1rem;
      line-height: 1.3;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
    }

    h2 {
      font-size: 2rem;
    }

    h3 {
      font-size: 1.5rem;
    }

    p {
      margin-bottom: 1rem;
      color: var(--text-secondary);
    }

    /* ====== ТОГГЛЕР ТЕМЫ ====== */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.5rem;
      margin-left: 10px;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: var(--light-gray);
    }

    /* ====== КНОПКИ И ФОРМЫ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 28px;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      outline: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: 2px solid var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
      border: 2px solid var(--secondary);
    }

    .btn-secondary:hover {
      background: var(--secondary-dark);
      border-color: var(--secondary-dark);
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn-icon {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 50%;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 15px;
      color: var(--text-color);
      background: var(--surface-color);
      transition: var(--transition);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    /* ====== НАВИГАЦИЯ ====== */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: var(--header-height);
      background: var(--surface-color);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 0 5%;
      border-bottom: 1px solid var(--border-color);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .nav-links {
      display: flex;
      gap: 4px;
      margin-left: 50px;
      flex: 1;
    }

    .nav-link {
      padding: 14px 22px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      border-radius: var(--radius);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .nav-link:hover {
      background: rgba(26, 54, 93, 0.05);
      color: var(--primary);
    }

    .nav-link.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
    }

    .cart-icon-wrapper {
      position: relative;
      cursor: pointer;
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      font-size: 12px;
      font-weight: 700;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      padding: 8px;
    }

    /* ====== ОСНОВНОЙ КОНТЕНТ ====== */
    .container {
      max-width: var(--container-width);
      margin: calc(var(--header-height) + 30px) auto 40px;
      padding: 0 20px;
      width: 100%;
    }

    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-header {
      margin-bottom: 40px;
      padding-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
    }

    .page-title {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }

    .page-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
    }

    .page-subtitle {
      font-size: 18px;
      color: var(--gray);
      font-weight: 400;
      margin-top: 5px;
    }

    /* ====== КАТАЛОГ ====== */
    .catalog-filters {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 40px;
      box-shadow: var(--shadow);
    }

    .filter-tags {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      overflow-x: auto;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .filter-tags::-webkit-scrollbar {
      height: 4px;
    }

    .filter-tags::-webkit-scrollbar-track {
      background: var(--light-gray);
      border-radius: 2px;
    }

    .filter-tags::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 2px;
    }

    .filter-tag {
      padding: 10px 24px;
      background: var(--light);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .filter-tag:hover {
      background: var(--primary-light);
      color: white;
      border-color: var(--primary-light);
    }

    .filter-tag.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
      margin-top: 20px;
    }

    .product-card {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      border: 1px solid var(--border-color);
    }

    .product-card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }

    .product-badge {
      position: absolute;
      top: 16px;
      left: 16px;
      padding: 6px 18px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      color: white;
      z-index: 2;
    }

    .badge-standard {
      background: var(--dark-gray);
    }

    .badge-premier {
      background: var(--primary);
    }

    .badge-prestige {
      background: var(--secondary);
      color: #000;
    }

    .product-image {
      height: 240px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 80px;
      position: relative;
      overflow: hidden;
    }

    .product-image::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .product-content {
      padding: 24px;
    }

    .product-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .product-price {
      color: var(--primary);
      font-size: 26px;
      font-weight: 700;
      margin: 20px 0;
    }

    .product-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--gray);
    }

    .product-description {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 24px;
      height: 72px;
      overflow: hidden;
    }

    .product-actions {
      display: flex;
      gap: 12px;
    }

    .btn-add-cart {
      flex: 1;
    }

    .btn-add-cart.added {
      background: var(--success);
      border-color: var(--success);
    }

    /* ====== КОРЗИНА ====== */
    .cart-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .cart-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .cart-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--surface-color);
      z-index: 2001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
    }

    .cart-sidebar.active {
      transform: translateX(0);
    }

    .cart-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--light);
    }

    .cart-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      color: var(--primary);
    }

    .cart-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .cart-empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--gray);
    }

    .cart-empty-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.3;
      color: var(--light-gray);
    }

    .cart-items {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .cart-item {
      display: flex;
      gap: 16px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-image {
      width: 90px;
      height: 90px;
      background: var(--light-gray);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      font-size: 36px;
      flex-shrink: 0;
    }

    .cart-item-info {
      flex: 1;
      min-width: 0; /* Предотвращает переполнение */
    }

    .cart-item-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cart-item-price {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 18px;
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--surface-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
    }

    .quantity-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .cart-footer {
      padding: 24px;
      border-top: 2px solid var(--border-color);
      background: var(--surface-color);
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      font-size: 18px;
    }

    .total-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    /* ====== 3D ПРИМЕРКА ====== */
    .fitting-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 30px;
    }

    .room-controls {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow);
      height: fit-content;
    }

    .room-visualization {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow);
      min-height: 650px;
      display: flex;
      flex-direction: column;
    }

    .room-3d-container {
      flex: 1;
      position: relative;
      background: linear-gradient(135deg, var(--light) 0%, var(--light-gray) 100%);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    #room-3d {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      perspective: 1200px;
      transform: rotateY(-15deg);
    }

    .room-walls {
      position: absolute;
      background: var(--surface-color);
      border: 1px solid rgba(0, 0, 0, 0.1);
      transform-style: preserve-3d;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
    }

    .furniture-item-3d {
      position: absolute;
      background: rgba(193, 154, 107, 0.8);
      border: 2px solid var(--secondary);
      border-radius: 6px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      transform-style: preserve-3d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .furniture-item-3d:hover {
      background: rgba(193, 154, 107, 0.9);
      z-index: 100;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .room-control-group {
      margin-bottom: 28px;
    }

    .control-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
    }

    .range-input {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--light-gray);
      outline: none;
      -webkit-appearance: none;
    }

    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 3px solid var(--surface-color);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .range-values {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 14px;
      color: var(--gray);
    }

    .furniture-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    .furniture-option {
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      background: var(--surface-color);
    }

    .furniture-option:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .furniture-option.selected {
      border-color: var(--primary);
      background: rgba(26, 54, 93, 0.05);
      box-shadow: 0 4px 12px rgba(26, 54, 93, 0.1);
    }

    .furniture-option i {
      font-size: 28px;
      margin-bottom: 10px;
      color: var(--primary);
    }

    /* Цветовой выбор */
    .color-picker-container {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: var(--transition);
      flex-shrink: 0;
    }

    .color-option.selected {
      border-color: var(--primary);
      transform: scale(1.1);
    }

    /* ====== ПРОФИЛЬ ====== */
    .profile-container {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
    }

    .profile-sidebar,
    .profile-content {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow);
    }

    .user-avatar {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      font-weight: 600;
    }

    /* ТЕКСТУРЫ ДЛЯ СТАТУСОВ */
    .loyalty-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 24px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }

    .loyalty-card.bronze {
      background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
      border-color: #CD7F32;
    }

    .loyalty-card.silver {
      background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
      border-color: #C0C0C0;
    }

    .loyalty-card.gold {
      background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
      border-color: #FFD700;
    }

    .loyalty-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    /* ====== КОНФИГУРАТОР ====== */
    .configurator-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .configurator-steps::-webkit-scrollbar {
      height: 4px;
    }

    .configurator-steps::-webkit-scrollbar-track {
      background: var(--light-gray);
      border-radius: 2px;
    }

    .configurator-steps::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 2px;
    }

    .configurator-steps::before {
      content: '';
      position: absolute;
      top: 22px;
      left: 5%;
      right: 5%;
      height: 2px;
      background: var(--light-gray);
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      background: var(--surface-color);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      border: 3px solid var(--light-gray);
      transition: var(--transition);
      font-size: 16px;
      color: var(--gray);
      flex-shrink: 0;
    }

    .step.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
    }

    .step.completed {
      border-color: var(--success);
      background: var(--success);
      color: white;
    }

    .step-content {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .config-option {
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .config-option:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .config-option.selected {
      border-color: var(--primary);
      background: rgba(26, 54, 93, 0.05);
      box-shadow: var(--shadow);
    }

    /* ====== МОДАЛЬНЫЕ ОКНА ====== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
      box-shadow: var(--shadow-lg);
      position: relative;
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--light-gray);
      color: var(--danger);
    }

    .modal-title {
      font-size: 28px;
      color: var(--primary);
      margin-bottom: 30px;
      text-align: center;
    }

    /* ====== ОТЗЫВЫ ====== */
    .reviews-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .review-card {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .review-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stars {
      color: #fbbf24;
      font-size: 20px;
      margin: 12px 0;
    }

    /* ====== КАРТА ====== */
    #map {
      height: 400px;
      border-radius: var(--radius-lg);
      margin-top: 20px;
      box-shadow: var(--shadow);
    }

    /* ====== АДАПТИВНОСТЬ ====== */
    @media (max-width: 1200px) {
      .fitting-container,
      .profile-container {
        grid-template-columns: 1fr;
      }

      .nav-links {
        margin-left: 30px;
      }

      .container {
        max-width: 100%;
        padding: 0 30px;
      }
    }

    @media (max-width: 1100px) {
      .nav-links {
        margin-left: 20px;
        gap: 2px;
      }
      
      .nav-link {
        padding: 12px 18px;
        font-size: 14px;
      }
      
      .logo {
        font-size: 20px;
      }
      
      .logo-icon {
        width: 38px;
        height: 38px;
      }
    }

    @media (max-width: 992px) {
      .container {
        padding: 0 20px;
      }

      .nav-links {
        display: none;
        position: absolute;
        top: var(--header-height);
        left: 0;
        right: 0;
        background: var(--surface-color);
        flex-direction: column;
        padding: 20px;
        box-shadow: var(--shadow);
        border-top: 1px solid var(--border-color);
        z-index: 1000;
        max-height: 80vh;
        overflow-y: auto;
      }

      .nav-links.active {
        display: flex;
      }

      .nav-link {
        padding: 16px;
        justify-content: center;
      }

      .mobile-menu-btn {
        display: block;
        margin-left: 15px;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }

      .cart-sidebar {
        width: 100%;
        max-width: 450px;
      }
      
      .page-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .page-icon {
        width: 56px;
        height: 56px;
        font-size: 22px;
      }
    }

    @media (max-width: 850px) {
      .fitting-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .room-controls {
        padding: 20px;
      }
      
      .room-visualization {
        padding: 20px;
        min-height: 500px;
      }
      
      .profile-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .profile-sidebar,
      .profile-content {
        padding: 20px;
      }
      
      .reviews-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }

      h2 {
        font-size: 1.75rem;
      }
      
      h3 {
        font-size: 1.35rem;
      }

      .page-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .page-icon {
        width: 56px;
        height: 56px;
        font-size: 22px;
      }

      .filter-tags {
        gap: 8px;
        padding-bottom: 15px;
      }

      .filter-tag {
        padding: 8px 20px;
        font-size: 14px;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
      }

      .reviews-grid {
        grid-template-columns: 1fr;
      }

      .configurator-steps::before {
        left: 5%;
        right: 5%;
      }

      .step {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .catalog-filters {
        padding: 20px;
      }
      
      .product-card {
        margin-bottom: 10px;
      }
      
      .cart-item {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .cart-item-image {
        width: 120px;
        height: 120px;
      }
    }

    @media (max-width: 650px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      }
      
      .user-avatar {
        width: 100px;
        height: 100px;
        font-size: 40px;
      }
      
      .loyalty-card {
        padding: 20px;
      }
      
      .configurator-steps {
        margin-bottom: 30px;
      }
      
      .step-content {
        padding: 20px;
      }
      
      .room-control-group {
        margin-bottom: 20px;
      }
      
      .furniture-selector {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .furniture-option {
        padding: 12px;
        font-size: 14px;
      }
      
      .furniture-option i {
        font-size: 24px;
      }
    }

    @media (max-width: 576px) {
      .navbar {
        padding: 0 15px;
      }

      .user-actions {
        gap: 12px;
      }

      .btn {
        padding: 10px 20px;
        font-size: 14px;
      }
      
      .btn-icon {
        width: 40px;
        height: 40px;
      }

      .page-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
      }

      .catalog-filters {
        padding: 20px;
      }

      .cart-item {
        flex-direction: column;
        text-align: center;
      }

      .cart-item-image {
        width: 100%;
        height: 150px;
      }

      .cart-item-actions {
        justify-content: center;
        flex-wrap: wrap;
      }

      .modal {
        padding: 25px;
        margin: 10px;
      }

      .modal-title {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .product-image {
        height: 200px;
        font-size: 60px;
      }
      
      .page-title {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .page-subtitle {
        font-size: 16px;
      }
      
      .container {
        padding: 0 15px;
      }
      
      .fitting-container {
        gap: 15px;
      }
      
      .room-controls {
        padding: 15px;
      }
      
      .room-visualization {
        padding: 15px;
        min-height: 450px;
      }
      
      .furniture-selector {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .furniture-option {
        padding: 12px;
        font-size: 14px;
      }
      
      .furniture-option i {
        font-size: 24px;
      }
      
      .configurator-steps::before {
        display: none;
      }
      
      .configurator-steps {
        justify-content: flex-start;
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .logo {
        font-size: 18px;
      }
      
      .logo-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
      
      .theme-toggle {
        font-size: 1.3rem;
        margin-left: 5px;
      }
      
      .user-actions {
        gap: 8px;
      }
      
      .page-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .filter-tag {
        padding: 6px 16px;
        font-size: 13px;
      }
      
      .product-price {
        font-size: 22px;
      }
      
      .product-actions {
        flex-direction: column;
      }
      
      .btn-add-cart {
        width: 100%;
      }
      
      .configurator-steps::before {
        display: none;
      }
      
      .configurator-steps {
        justify-content: center;
        gap: 15px;
      }
      
      .step {
        width: 32px;
        height: 32px;
        font-size: 13px;
      }
      
      #map {
        height: 300px;
      }
      
      .modal {
        padding: 20px 15px;
      }
      
      .nav-link span {
        display: none;
      }
      
      .nav-link i {
        font-size: 18px;
      }
      
      .cart-sidebar {
        width: 100%;
      }
      
      .room-controls {
        overflow: hidden;
      }
    }

    @media (max-width: 400px) {
      .container {
        padding: 0 10px;
      }
      
      .navbar {
        padding: 0 10px;
      }
      
      .product-content {
        padding: 15px;
      }
      
      .product-title {
        font-size: 16px;
      }
      
      .product-price {
        font-size: 20px;
      }
      
      .cart-sidebar {
        width: 100%;
      }
      
      .cart-header {
        padding: 15px;
      }
      
      .cart-content {
        padding: 15px;
      }
      
      .cart-footer {
        padding: 15px;
      }
      
      .total-amount {
        font-size: 26px;
      }
      
      .room-controls {
        padding: 12px;
      }
      
      .room-visualization {
        padding: 12px;
        min-height: 400px;
      }
      
      .profile-sidebar,
      .profile-content {
        padding: 15px;
      }
      
      .logo span {
        display: none;
      }
      
      .nav-link {
        padding: 12px;
      }
      
      .filter-tags {
        margin-bottom: 10px;
      }
    }

    @media (max-width: 360px) {
      .logo {
        min-width: auto;
      }
      
      .logo-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }
      
      .user-actions {
        gap: 5px;
      }
      
      .btn {
        padding: 8px 15px;
        font-size: 13px;
      }
      
      .btn-icon {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .page-icon {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .filter-tags {
        justify-content: flex-start;
      }
      
      .filter-tag {
        padding: 5px 12px;
        font-size: 12px;
      }
      
      .product-image {
        height: 180px;
        font-size: 60px;
      }
      
      .product-content {
        padding: 12px;
      }
      
      .cart-item-image {
        width: 100px;
        height: 100px;
      }
      
      .room-controls {
        padding: 10px;
      }
      
      .room-visualization {
        padding: 10px;
        min-height: 350px;
      }
      
      .furniture-option {
        padding: 8px;
        font-size: 12px;
      }
      
      .furniture-option i {
        font-size: 20px;
      }
    }

    @media (max-width: 320px) {
      .container {
        padding: 0 8px;
      }
      
      .navbar {
        padding: 0 8px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .btn-icon {
        width: 32px;
        height: 32px;
      }
      
      .page-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .product-image {
        height: 160px;
        font-size: 50px;
      }
      
      .product-price {
        font-size: 18px;
      }
      
      .cart-item-actions {
        flex-direction: column;
        gap: 10px;
      }
      
      .quantity-control {
        width: 100%;
        justify-content: center;
      }
      
      .room-3d-container {
        min-height: 250px;
      }
      
      .config-option {
        padding: 12px;
      }
      
      .config-option i {
        font-size: 36px;
      }
    }

    /* ====== УТИЛИТЫ ====== */
    .text-center {
      text-align: center;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .mb-30 {
      margin-bottom: 30px;
    }

    .mb-40 {
      margin-bottom: 40px;
    }

    .p-20 {
      padding: 20px;
    }

    .hidden {
      display: none !important;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--success);
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 4000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 400px;
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--info);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* ====== ЛОАДЕР ====== */
    .loader {
      display: inline-block;
      width: 80px;
      height: 80px;
    }

    .loader:after {
      content: " ";
      display: block;
      width: 64px;
      height: 64px;
      margin: 8px;
      border-radius: 50%;
      border: 6px solid var(--primary);
      border-color: var(--primary) transparent var(--primary) transparent;
      animation: loader 1.2s linear infinite;
    }

    @keyframes loader {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .card {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    /* Для очень маленьких экранов */
    @media (max-height: 600px) {
      .cart-sidebar {
        height: 100vh;
      }
      
      .room-3d-container {
        height: 300px;
      }
      
      .modal {
        max-height: 80vh;
      }
      
      .nav-links.active {
        max-height: 70vh;
      }
    }
    
    /* Конфигуратор - дополнительное поле выбора */
    .material-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .material-option {
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .material-option:hover {
      border-color: var(--primary);
    }
    
    .material-option.selected {
      border-color: var(--primary);
      background: rgba(26, 54, 93, 0.05);
    }
    
    /* Фикс для переполнения текста */
    .text-ellipsis {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Скрытие текста на очень маленьких экранах */
    .hide-on-mobile {
      display: inline;
    }
    
    @media (max-width: 480px) {
      .hide-on-mobile {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- НАВИГАЦИЯ -->
  <nav class="navbar">
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-couch"></i>
      </div>
      <span class="hide-on-mobile">Удобство 58</span>
    </div>

    <div class="nav-links" id="nav-links">
      <a href="#" class="nav-link active" data-page="home">
        <i class="fas fa-home"></i><span class="hide-on-mobile">Главная</span>
      </a>
      <a href="#" class="nav-link" data-page="catalog">
        <i class="fas fa-th-large"></i><span class="hide-on-mobile">Каталог</span>
      </a>
      <a href="#" class="nav-link" data-page="profile">
        <i class="fas fa-user"></i><span class="hide-on-mobile">Профиль</span>
      </a>
      <a href="#" class="nav-link" data-page="about">
        <i class="fas fa-info-circle"></i><span class="hide-on-mobile">О нас</span>
      </a>
      <a href="#" class="nav-link" data-page="fitting">
        <i class="fas fa-cube"></i><span class="hide-on-mobile">3D Примерка</span>
      </a>
      <a href="#" class="nav-link" data-page="configurator">
        <i class="fas fa-sliders-h"></i><span class="hide-on-mobile">Конфигуратор</span>
      </a>
      <a href="#" class="nav-link" data-page="reviews">
        <i class="fas fa-star"></i><span class="hide-on-mobile">Отзывы</span>
      </a>
      <a href="#" class="nav-link" data-page="contacts">
        <i class="fas fa-map-marker-alt"></i><span class="hide-on-mobile">Контакты</span>
      </a>
      <a href="#" class="nav-link" data-page="tracking" id="tracking-tab" style="display: none;">
        <i class="fas fa-shipping-fast"></i><span class="hide-on-mobile">Статус заказа</span>
      </a>
      <a href="#" class="nav-link" data-page="admin" id="admin-tab" style="display: none;">
        <i class="fas fa-cog"></i><span class="hide-on-mobile">Админ</span>
      </a>
    </div>

    <div class="user-actions">
      <div class="cart-icon-wrapper" onclick="toggleCart()">
        <button class="btn btn-icon">
          <i class="fas fa-shopping-cart"></i>
        </button>
        <span class="cart-count" id="cart-count">0</span>
      </div>

      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>

      <button class="btn btn-outline" id="auth-btn" onclick="toggleAuthModal()">
        <i class="fas fa-sign-in-alt"></i><span class="hide-on-mobile">Войти</span>
      </button>

      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- ОСНОВНОЙ КОНТЕНТ -->
  <div class="container">
    <!-- ГЛАВНАЯ СТРАНИЦА -->
    <div class="page active" id="home">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-couch"></i>
          </div>
          <div>
            Мебель вашей мечты
            <div class="page-subtitle">
              Премиальная мебель по индивидуальным размерам с гарантией 10 лет
            </div>
          </div>
        </h1>
      </div>

      <div class="card mb-40">
        <div style="text-align: center; padding: 50px 30px;">
          <h2 style="margin-bottom: 20px;">Создайте свой идеальный интерьер</h2>
          <p style="font-size: 18px; color: var(--text-secondary); max-width: 800px; margin: 0 auto 30px;">
            От эскиза до готового изделия - мы создаем уникальные интерьерные решения, которые отражают ваш стиль и обеспечивают максимальный комфорт.
          </p>
          <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="switchPage('catalog')" style="padding: 16px 40px;">
              <i class="fas fa-box-open"></i>Перейти в каталог
            </button>
            <button class="btn btn-outline" onclick="switchPage('fitting')" style="padding: 16px 40px;">
              <i class="fas fa-cube"></i>3D Примерка
            </button>
          </div>
        </div>
      </div>

      <div class="products-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-ruler-combined"></i>
          </div>
          <h3>Индивидуальные размеры</h3>
          <p>Изготовим мебель по вашим точным размерам с учетом особенностей помещения и пожеланий.</p>
        </div>

        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-truck"></i>
          </div>
          <h3>Бесплатная доставка</h3>
          <p>Доставка при заказе от 50 000 ₽. Аккуратная доставка и профессиональная сборка нашими специалистами.</p>
        </div>

        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3>Гарантия 10 лет</h3>
          <p>На всю нашу продукцию предоставляется расширенная гарантия. Используем только качественные материалы.</p>
        </div>
      </div>
    </div>

    <!-- КАТАЛОГ -->
    <div class="page" id="catalog">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-th-large"></i>
          </div>
          <div>
            Каталог мебели
            <div class="page-subtitle">
              Более 40 моделей в 10 категориях
            </div>
          </div>
        </h1>
      </div>

      <div class="catalog-filters">
        <h3 style="margin-bottom: 20px;">Категории</h3>
        <div class="filter-tags">
          <button class="filter-tag active" data-category="all">Все товары</button>
          <button class="filter-tag" data-category="table">Столы</button>
          <button class="filter-tag" data-category="chair">Стулья</button>
          <button class="filter-tag" data-category="wardrobe">Шкафы</button>
          <button class="filter-tag" data-category="bed">Кровати</button>
          <button class="filter-tag" data-category="shelf">Полки</button>
          <button class="filter-tag" data-category="kitchen">Кухни</button>
          <button class="filter-tag" data-category="sofa">Диваны</button>
          <button class="filter-tag" data-category="cabinet">Тумбы</button>
          <button class="filter-tag" data-category="dresser">Комоды</button>
        </div>
      </div>

      <div id="products-container" class="products-grid">
        <!-- Товары будут загружены через JavaScript -->
      </div>
    </div>

    <!-- ПРОФИЛЬ -->
    <div class="page" id="profile">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-user"></i>
          </div>
          <div>
            Мой профиль
            <div class="page-subtitle" id="profile-subtitle">
              Не авторизован
            </div>
          </div>
        </h1>
      </div>

      <div class="profile-container">
        <div class="profile-sidebar">
          <div class="user-avatar" id="profile-avatar">
            <i class="fas fa-user"></i>
          </div>

          <div style="text-align: center; margin-bottom: 30px;">
            <h2 id="profile-name">Гость</h2>
            <p id="profile-email" style="color: var(--gray);">Для входа нажмите "Войти"</p>
          </div>

          <div id="loyalty-card" class="loyalty-card hidden">
            <h3 style="color: white; margin-bottom: 15px;" id="loyalty-title">Бронзовый уровень</h3>
            <div class="progress-bar" style="height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; margin: 20px 0;">
              <div id="loyalty-progress" style="height: 100%; background: white; border-radius: 4px; width: 30%;"></div>
            </div>
            <p style="font-size: 14px; margin: 10px 0;">Скидка: <span id="discount-percent" style="font-weight: 700;">0%</span></p>
            <p style="font-size: 12px; opacity: 0.9;">До следующего уровня: <span id="next-level">100 000 ₽</span></p>
          </div>

          <div style="margin-top: 30px;">
            <button class="btn btn-primary" id="logout-btn" onclick="logout()" style="width: 100%; display: none;">
              <i class="fas fa-sign-out-alt"></i>Выйти
            </button>
            <button class="btn btn-outline" onclick="toggleAuthModal()" id="login-profile-btn" style="width: 100%;">
              <i class="fas fa-sign-in-alt"></i>Войти / Зарегистрироваться
            </button>
          </div>
        </div>

        <div class="profile-content">
          <h3 style="margin-bottom: 25px;">История заказов</h3>
          <div id="orders-list" style="text-align: center; padding: 40px 20px; color: var(--gray);">
            <i class="fas fa-box-open" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
            <p>Для просмотра истории заказов необходимо авторизоваться</p>
          </div>
        </div>
      </div>
    </div>

    <!-- О НАС -->
    <div class="page" id="about">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-info-circle"></i>
          </div>
          <div>
            О компании
            <div class="page-subtitle">
              Премиальная мебель с 2005 года
            </div>
          </div>
        </h1>
      </div>

      <div class="card mb-30">
        <h2 style="margin-bottom: 20px;">Наша история</h2>
        <p style="font-size: 17px; line-height: 1.7;">
          "Удобство 58" - это семейная компания, основанная в 2005 году. Начиная с небольшой мастерской по производству кухонной мебели, мы выросли в одного из лидеров рынка премиальной мебели в России.
        </p>
        <p style="font-size: 17px; line-height: 1.7; margin-top: 20px;">
          Сегодня наша фабрика площадью 10 000 м² оснащена современным итальянским оборудованием, а в коллективе работают более 150 профессионалов своего дела.
        </p>
      </div>

      <div class="products-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-industry"></i>
          </div>
          <h3>Наше производство</h3>
          <p>Используем только экологичные материалы от проверенных поставщиков из Европы и России.</p>
        </div>

        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-users"></i>
          </div>
          <h3>Наша команда</h3>
          <p>Дизайнеры, технологи и мастера с опытом работы от 10 лет. Каждый специалист - эксперт в своей области.</p>
        </div>

        <div class="card">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; color: white; font-size: 28px;">
            <i class="fas fa-award"></i>
          </div>
          <h3>Наши ценности</h3>
          <p>Качество, индивидуальный подход, экологичность, инновации и долгосрочные отношения с клиентами.</p>
        </div>
      </div>
    </div>

    <!-- 3D ПРИМЕРКА -->
    <div class="page" id="fitting">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-cube"></i>
          </div>
          <div>
            3D Планировщик комнаты
            <div class="page-subtitle">
              Спроектируйте свой интерьер в реальном времени
            </div>
          </div>
        </h1>
      </div>

      <div class="fitting-container">
        <div class="room-controls">
          <h3 style="margin-bottom: 25px;">Параметры комнаты</h3>

          <div class="room-control-group">
            <label class="control-label">
              Длина комнаты
              <span id="length-value">4 м</span>
            </label>
            <input type="range" class="range-input" id="room-length" min="2" max="10" value="4" step="0.5">
            <div class="range-values">
              <span>2 м</span>
              <span>10 м</span>
            </div>
          </div>

          <div class="room-control-group">
            <label class="control-label">
              Ширина комнаты
              <span id="width-value">3 м</span>
            </label>
            <input type="range" class="range-input" id="room-width" min="2" max="8" value="3" step="0.5">
            <div class="range-values">
              <span>2 м</span>
              <span>8 м</span>
            </div>
          </div>

          <div class="room-control-group">
            <label class="control-label">
              Высота потолков
              <span id="height-value">2.5 м</span>
            </label>
            <input type="range" class="range-input" id="room-height" min="2" max="4" value="2.5" step="0.1">
            <div class="range-values">
              <span>2 м</span>
              <span>4 м</span>
            </div>
          </div>

          <div class="room-control-group">
            <label class="control-label">Цвет стен</label>
            <input type="color" id="wall-color" value="#f5f5f5" style="width: 100%; height: 40px; border-radius: var(--radius); border: 1px solid var(--border-color);">
          </div>

          <div class="room-control-group">
            <label class="control-label">Цвет пола</label>
            <input type="color" id="floor-color" value="#8B4513" style="width: 100%; height: 40px; border-radius: var(--radius); border: 1px solid var(--border-color);">
          </div>

          <h3 style="margin: 30px 0 20px;">Добавить мебель</h3>
          <div class="furniture-selector" id="furniture-selector">
            <!-- Мебель будет загружена через JavaScript -->
          </div>

          <button class="btn btn-primary" onclick="addSelectedFurniture()" style="width: 100%; margin-top: 25px; padding: 14px;">
            <i class="fas fa-plus"></i>Добавить в комнату
          </button>

          <button class="btn btn-outline" onclick="resetRoom()" style="width: 100%; margin-top: 12px; padding: 14px;">
            <i class="fas fa-redo"></i>Сбросить комнату
          </button>

          <div style="margin-top: 30px; padding: 20px; background: var(--light); border-radius: var(--radius);">
            <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
              <i class="fas fa-lightbulb"></i> <strong>Совет:</strong> Перетаскивайте мебель для расстановки. Удерживайте Shift для изменения размера.
            </p>
          </div>
        </div>

        <div class="room-visualization">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>3D Вид комнаты</h3>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-icon" onclick="rotateView('left')">
                <i class="fas fa-undo"></i>
              </button>
              <button class="btn btn-icon" onclick="rotateView('right')">
                <i class="fas fa-redo"></i>
              </button>
              <button class="btn btn-icon" onclick="resetView()">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>

          <div class="room-3d-container">
            <div id="room-3d">
              <!-- 3D комната будет создана здесь -->
            </div>
          </div>

          <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="recommended-furniture">
            <!-- Рекомендованные товары -->
          </div>
        </div>
      </div>
    </div>

    <!-- КОНФИГУРАТОР -->
    <div class="page" id="configurator">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-sliders-h"></i>
          </div>
          <div>
            Конфигуратор мебели
            <div class="page-subtitle">
              Создайте мебель своей мечты за 5 шагов
            </div>
          </div>
        </h1>
      </div>

      <div class="card">
        <div class="configurator-steps">
          <div class="step active" id="step-1">1</div>
          <div class="step" id="step-2">2</div>
          <div class="step" id="step-3">3</div>
          <div class="step" id="step-4">4</div>
          <div class="step" id="step-5">5</div>
        </div>

        <div id="configurator-content" class="step-content" style="min-height: 400px; padding: 30px 0;">
          <!-- Контент конфигуратора -->
        </div>

        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
          <button id="prev-step" class="btn btn-outline" style="display: none;" onclick="prevStep()">
            <i class="fas fa-arrow-left"></i>Назад
          </button>
          <button id="next-step" class="btn btn-primary" onclick="nextStep()">
            Далее<i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ОТЗЫВЫ -->
    <div class="page" id="reviews">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-star"></i>
          </div>
          <div>
            Отзывы клиентов
            <div class="page-subtitle">
              На основе 156 отзывов
            </div>
          </div>
        </h1>
      </div>

      <div class="card mb-30">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 30px;">
          <div style="text-align: center;">
            <div style="font-size: 60px; font-weight: 700; color: var(--secondary);">4.8</div>
            <div class="stars">★★★★★</div>
            <p style="color: var(--gray); margin-top: 10px;">Средняя оценка</p>
          </div>

          <button class="btn btn-secondary" id="add-review-btn" onclick="showReviewModal()" style="display: none;">
            <i class="fas fa-plus"></i>Добавить отзыв
          </button>
        </div>
      </div>

      <div class="reviews-grid" id="reviews-list">
        <!-- Отзывы будут загружены здесь -->
      </div>
    </div>

    <!-- КОНТАКТЫ -->
    <div class="page" id="contacts">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div>
            Контакты
            <div class="page-subtitle">
              Всегда на связи
            </div>
          </div>
        </h1>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 40px;">
        <div class="card">
          <h3 style="margin-bottom: 25px;">Наши контакты</h3>
          <div style="display: grid; gap: 25px;">
            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 48px; height: 48px; background: var(--light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                <i class="fas fa-phone"></i>
              </div>
              <div>
                <p style="font-weight: 600; color: var(--text-color);">Телефон</p>
                <p style="color: var(--gray);">+7 (800) 555-58-58</p>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 48px; height: 48px; background: var(--light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                <i class="fas fa-envelope"></i>
              </div>
              <div>
                <p style="font-weight: 600; color: var(--text-color);">Email</p>
                <p style="color: var(--gray);">info@udobstvo58.ru</p>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 48px; height: 48px; background: var(--light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div>
                <p style="font-weight: 600; color: var(--text-color);">Адрес</p>
                <p style="color: var(--gray);">г. Москва, ул. Мебельная, д. 58</p>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 48px; height: 48px; background: var(--light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                <i class="fas fa-clock"></i>
              </div>
              <div>
                <p style="font-weight: 600; color: var(--text-color);">Часы работы</p>
                <p style="color: var(--gray);">Пн-Пт: 9:00-21:00<br>Сб-Вс: 10:00-20:00</p>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h3 style="margin-bottom: 20px;">На карте</h3>
          <div id="map"></div>
        </div>
      </div>

      <div class="card" style="text-align: center;">
        <h2 style="margin-bottom: 20px;">Мы будем вас ждать!</h2>
        <p style="font-size: 17px; color: var(--text-secondary); max-width: 800px; margin: 0 auto;">
          Приходите к нам в гости, чтобы увидеть и прочувствовать качество нашей мебели. Наши консультанты помогут подобрать идеальное решение для вашего дома или офиса.
        </p>
      </div>
    </div>

    <!-- СТАТУС ЗАКАЗА -->
    <div class="page" id="tracking">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <div>
            Статус заказа
            <div class="page-subtitle">
              Отслеживание ваших заказов
            </div>
          </div>
        </h1>
      </div>

      <div id="order-tracking">
        <!-- Информация о заказах -->
      </div>
    </div>

    <!-- АДМИН ПАНЕЛЬ -->
    <div class="page" id="admin">
      <div class="page-header">
        <h1 class="page-title">
          <div class="page-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div>
            Административная панель
            <div class="page-subtitle">
              Управление системой
            </div>
          </div>
        </h1>
      </div>

      <div class="catalog-filters" style="margin-bottom: 30px;">
        <div class="filter-tags" id="admin-tabs">
          <button class="filter-tag active" data-tab="products">
            <i class="fas fa-box"></i>Товары
          </button>
          <button class="filter-tag" data-tab="orders">
            <i class="fas fa-shopping-cart"></i>Заказы
          </button>
          <button class="filter-tag" data-tab="reviews-admin">
            <i class="fas fa-star"></i>Отзывы
          </button>
          <button class="filter-tag" data-tab="users">
            <i class="fas fa-users"></i>Пользователи
          </button>
        </div>
      </div>

      <div id="admin-content">
        <!-- Контент админ панели -->
      </div>
    </div>
  </div>

  <!-- КОРЗИНА -->
  <div class="cart-overlay" id="cart-overlay" onclick="toggleCart()"></div>
  <div class="cart-sidebar" id="cart-sidebar">
    <div class="cart-header">
      <h2 class="cart-title">
        <i class="fas fa-shopping-cart"></i>
        Корзина
      </h2>
      <button class="btn btn-icon" onclick="toggleCart()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="cart-content" id="cart-content">
      <div class="cart-empty">
        <i class="fas fa-shopping-cart cart-empty-icon"></i>
        <h3>Корзина пуста</h3>
        <p>Добавьте товары из каталога</p>
      </div>
    </div>

    <div class="cart-footer">
      <div class="cart-total">
        <span>Итого:</span>
        <span class="total-amount" id="cart-total">0 ₽</span>
      </div>
      <button class="btn btn-primary" onclick="checkout()" style="width: 100%; padding: 16px;">
        <i class="fas fa-credit-card"></i>Оформить заказ
      </button>
    </div>
  </div>

  <!-- МОДАЛЬНОЕ ОКНО АВТОРИЗАЦИИ -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal">
      <button class="modal-close" onclick="toggleAuthModal()">
        <i class="fas fa-times"></i>
      </button>

      <div id="auth-forms">
        <div id="login-form">
          <h2 class="modal-title">Вход в аккаунт</h2>

          <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Email</label>
            <input type="email" id="login-email" placeholder="Введите ваш email" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px;">
          </div>

          <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Пароль</label>
            <input type="password" id="login-password" placeholder="Введите ваш пароль" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px;">
          </div>

          <button class="btn btn-primary" onclick="login()" style="width: 100%; padding: 16px;">
            <i class="fas fa-sign-in-alt"></i>Войти
          </button>

          <div style="text-align: center; margin-top: 25px;">
            <p style="color: var(--gray);">
              Нет аккаунта?
              <a href="#" onclick="showRegisterForm()" style="color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer;">
                Зарегистрироваться
              </a>
            </p>
          </div>
        </div>

        <div id="register-form" style="display: none;">
          <h2 class="modal-title">Регистрация</h2>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ФИО</label>
            <input type="text" id="register-name" placeholder="Иванов Иван Иванович" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Email</label>
            <input type="email" id="register-email" placeholder="example@mail.ru" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px;">
          </div>

          <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Пароль</label>
            <input type="password" id="register-password" placeholder="Придумайте пароль" style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px;">
          </div>

          <button class="btn btn-secondary" onclick="register()" style="width: 100%; padding: 16px;">
            <i class="fas fa-user-plus"></i>Зарегистрироваться
          </button>

          <div style="text-align: center; margin-top: 25px;">
            <p style="color: var(--gray);">
              Уже есть аккаунт?
              <a href="#" onclick="showLoginForm()" style="color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer;">
                Войти
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- МОДАЛЬНОЕ ОКНО ОТЗЫВА -->
  <div class="modal-overlay" id="review-modal">
    <div class="modal">
      <button class="modal-close" onclick="closeReviewModal()">
        <i class="fas fa-times"></i>
      </button>

      <h2 class="modal-title">Добавить отзыв</h2>

      <div style="margin-bottom: 25px; text-align: center;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-color);">Оценка</label>
        <div id="rating-stars" style="font-size: 36px; color: #ddd; cursor: pointer;">
          <i class="fas fa-star" data-rating="1"></i>
          <i class="fas fa-star" data-rating="2"></i>
          <i class="fas fa-star" data-rating="3"></i>
          <i class="fas fa-star" data-rating="4"></i>
          <i class="fas fa-star" data-rating="5"></i>
        </div>
        <input type="hidden" id="review-rating" value="5">
      </div>

      <div style="margin-bottom: 30px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">Текст отзыва</label>
        <textarea id="review-text" rows="5" placeholder="Поделитесь впечатлениями о покупке..." style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px; resize: vertical;"></textarea>
      </div>

      <button class="btn btn-secondary" onclick="submitReview()" style="width: 100%; padding: 16px;">
        <i class="fas fa-paper-plane"></i>Опубликовать отзыв
      </button>
    </div>
  </div>

  <!-- Внешние скрипты -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/coloris/0.20.0/coloris.min.js"></script>

  <script>
    // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И ИНИЦИАЛИЗАЦИЯ ==========
    // Проверка поддержки localStorage
    let localStorageAvailable = true;
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
    } catch (e) {
      localStorageAvailable = false;
      console.log('localStorage не доступен');
    }

    let currentUser = localStorageAvailable ? JSON.parse(localStorage.getItem('currentUser')) || null : null;
    let cart = localStorageAvailable ? JSON.parse(localStorage.getItem('cart')) || [] : [];
    let users = localStorageAvailable ? JSON.parse(localStorage.getItem('users')) || getDefaultUsers() : getDefaultUsers();
    let products = localStorageAvailable ? JSON.parse(localStorage.getItem('products')) || getDefaultProducts() : getDefaultProducts();
    let reviews = localStorageAvailable ? JSON.parse(localStorage.getItem('reviews')) || getDefaultReviews() : getDefaultReviews();
    let orders = localStorageAvailable ? JSON.parse(localStorage.getItem('orders')) || [] : [];
    let currentPage = 'home';
    let room3d = null;
    let selectedFurnitureType = 'table';
    let configuratorData = {
      step: 1,
      category: '',
      size: '',
      budget: '',
      material: '',
      results: []
    };
    let isDarkTheme = localStorageAvailable && localStorage.getItem('darkTheme') === 'true';

    // Инициализация Coloris
    function initializeColoris() {
      if (typeof Coloris !== 'undefined') {
        Coloris({
          theme: 'default',
          themeMode: 'auto',
          format: 'hex',
          alpha: false,
          margin: 2,
          wrap: true,
          defaultColor: '#1a365d'
        });
      }
    }

    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      initApp();
      setupEventListeners();
      
      // Инициализируем Coloris после загрузки DOM
      setTimeout(initializeColoris, 100);
      
      // Загружаем каталог с задержкой для гарантии загрузки данных
      setTimeout(() => {
        loadCatalog();
        loadFurnitureSelector();
      }, 100);
      
      loadReviews();
      initFittingRoom();
      updateUI();
      updateCartCounter();
      
      setTimeout(() => {
        if (!currentUser && !localStorageAvailable) {
          showWelcomeModal();
        } else if (!currentUser && localStorageAvailable && !localStorage.getItem('welcomeShown')) {
          showWelcomeModal();
          localStorage.setItem('welcomeShown', 'true');
        }
      }, 2000);
    });

    function initTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      if (isDarkTheme) {
        document.body.classList.add('dark-theme');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }

    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      if (localStorageAvailable) {
        localStorage.setItem('darkTheme', isDarkTheme);
      }
      document.body.classList.toggle('dark-theme');
      const themeToggle = document.getElementById('theme-toggle');
      if (isDarkTheme) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
      
      // Обновляем Coloris для новой темы
      if (typeof Coloris !== 'undefined') {
        Coloris.setInstance('.coloris', {
          theme: isDarkTheme ? 'dark' : 'default',
          themeMode: 'auto'
        });
      }
    }

    function initApp() {
      updateCartDisplay();
      updateCartCounter();
      initConfigurator();
      initMap();
    }

    function setupEventListeners() {
      // Навигация
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          switchPage(page);
        });
      });
      
      // Фильтры каталога
      document.querySelectorAll('.filter-tag[data-category]').forEach(tag => {
        tag.addEventListener('click', function() {
          document.querySelectorAll('.filter-tag[data-category]').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          const category = this.getAttribute('data-category');
          filterProducts(category);
        });
      });
      
      // Админ вкладки
      document.querySelectorAll('.filter-tag[data-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.filter-tag[data-tab]').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          const tabName = this.getAttribute('data-tab');
          if (currentUser && currentUser.role === 'admin') {
            showAdminTab(tabName);
          }
        });
      });
      
      // Выбор мебели в 3D примерке
      document.addEventListener('click', function(e) {
        if (e.target.closest('.furniture-option')) {
          const option = e.target.closest('.furniture-option');
          document.querySelectorAll('.furniture-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedFurnitureType = option.getAttribute('data-type');
        }
      });
      
      // Обновление значений ползунков
      ['room-length', 'room-width', 'room-height'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', function() {
            updateSliderValue(id, this.value);
            if (room3d) updateRoom();
          });
        }
      });
      
      // Цвета стен и пола
      document.getElementById('wall-color')?.addEventListener('input', function() {
        if (room3d) updateRoom();
      });
      
      document.getElementById('floor-color')?.addEventListener('input', function() {
        if (room3d) updateRoom();
      });
      
      // Звезды рейтинга
      document.querySelectorAll('#rating-stars i').forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          setRating(rating);
        });
      });
    }

    function loadFurnitureSelector() {
      const container = document.getElementById('furniture-selector');
      if (!container) return;
      
      const categories = [...new Set(products.map(p => p.category))];
      let html = '';
      
      categories.forEach(category => {
        const product = products.find(p => p.category === category);
        if (!product) return;
        
        const icon = product.icon || 'fa-cube';
        const name = getCategoryName(category);
        
        html += `
          <div class="furniture-option ${category === 'table' ? 'selected' : ''}" data-type="${category}">
            <i class="fas ${icon}"></i>
            <div>${name}</div>
          </div>`;
      });
      
      container.innerHTML = html;
      selectedFurnitureType = 'table';
      
      // Добавляем обработчик событий
      container.addEventListener('click', function(e) {
        const option = e.target.closest('.furniture-option');
        if (option) {
          document.querySelectorAll('.furniture-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedFurnitureType = option.getAttribute('data-type');
          showRecommendedFurniture();
        }
      });
    }

    // ========== ОСНОВНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ ==========
    function switchPage(pageName) {
      // Скрываем все страницы
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Удаляем активный класс у всех ссылок
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Находим нужную страницу
      const pageElement = document.getElementById(pageName);
      if (pageElement) {
        pageElement.classList.add('active');
        
        // Находим ссылку на эту страницу и делаем ее активной
        const navLink = document.querySelector(`[data-page="${pageName}"]`);
        if (navLink) {
          navLink.classList.add('active');
        }
        
        currentPage = pageName;
        
        // Закрываем мобильное меню
        const navLinks = document.getElementById('nav-links');
        if (navLinks) {
          navLinks.classList.remove('active');
        }
        
        // Загружаем контент для конкретной страницы
        switch (pageName) {
          case 'catalog':
            loadCatalog();
            break;
          case 'profile':
            updateProfile();
            break;
          case 'fitting':
            initFittingRoom();
            break;
          case 'configurator':
            initConfigurator();
            break;
          case 'reviews':
            loadReviews();
            break;
          case 'tracking':
            loadOrderTracking();
            break;
          case 'admin':
            if (currentUser && currentUser.role === 'admin') {
              initAdminPanel();
            } else {
              switchPage('home');
            }
            break;
          case 'contacts':
            setTimeout(initMap, 100); // Даем время для рендеринга карты
            break;
        }
      } else {
        console.error('Страница не найдена:', pageName);
      }
    }

    function toggleMobileMenu() {
      const navLinks = document.getElementById('nav-links');
      if (navLinks) {
        navLinks.classList.toggle('active');
      }
    }

    function updateUI() {
      const authBtn = document.getElementById('auth-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const loginProfileBtn = document.getElementById('login-profile-btn');
      const trackingTab = document.getElementById('tracking-tab');
      const adminTab = document.getElementById('admin-tab');
      const addReviewBtn = document.getElementById('add-review-btn');
      const profileSubtitle = document.getElementById('profile-subtitle');
      
      if (currentUser) {
        authBtn.innerHTML = `<i class="fas fa-user"></i><span class="hide-on-mobile">${currentUser.name.split(' ')[0]}</span>`;
        authBtn.onclick = function() {
          if (currentPage !== 'profile') switchPage('profile');
        };
        
        if (logoutBtn) logoutBtn.style.display = 'block';
        if (loginProfileBtn) loginProfileBtn.style.display = 'none';
        
        if (trackingTab) trackingTab.style.display = 'block';
        if (addReviewBtn) addReviewBtn.style.display = 'block';
        
        if (profileSubtitle) profileSubtitle.textContent = currentUser.email;
        
        if (currentUser.role === 'admin' && adminTab) {
          adminTab.style.display = 'block';
        } else if (adminTab) {
          adminTab.style.display = 'none';
        }
      } else {
        authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span class="hide-on-mobile">Войти</span>';
        authBtn.onclick = toggleAuthModal;
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (loginProfileBtn) loginProfileBtn.style.display = 'block';
        if (trackingTab) trackingTab.style.display = 'none';
        if (adminTab) adminTab.style.display = 'none';
        if (addReviewBtn) addReviewBtn.style.display = 'none';
        if (profileSubtitle) profileSubtitle.textContent = 'Не авторизован';
      }
    }

    // ========== КАТАЛОГ И ТОВАРЫ ==========
    function loadCatalog() {
      const container = document.getElementById('products-container');
      if (!container) return;
      
      let html = '';
      products.forEach(product => {
        const badgeClass = `badge-${product.type}`;
        const badgeText = product.type === 'standard' ? 'Стандарт' :
          product.type === 'premier' ? 'Премьер' : 'Престиж';
        const cartItem = cart.find(item => item.id === product.id);
        const inCart = cartItem ? true : false;
        const quantity = cartItem ? cartItem.quantity : 0;
        const buttonText = quantity > 0 ? `В корзине (${quantity})` : 'В корзину';
        const buttonClass = inCart ? 'btn btn-secondary added' : 'btn btn-primary';
        
        // Безопасное получение цвета
        const color = product.color || '#1a365d';
        const darkColor = darkenColor(color, 30);
        
        html += `
          <div class="product-card" data-category="${product.category}" data-type="${product.type}" data-id="${product.id}">
            <div class="product-badge ${badgeClass}">${badgeText}</div>
            <div class="product-image" style="background: linear-gradient(135deg, ${color} 0%, ${darkColor} 100%);">
              <i class="fas ${product.icon || 'fa-cube'}"></i>
            </div>
            <div class="product-content">
              <h3 class="product-title">${product.name}</h3>
              
              <div class="product-meta">
                <span class="product-material">${product.material || 'Не указано'}</span>
                <span class="product-dimensions">${product.dimensions || 'Не указано'}</span>
              </div>
              
              <p class="product-description">${product.description || ''}</p>
              
              <div class="product-price">${formatPrice(product.price)}</div>
              
              <div class="product-actions">
                <button class="${buttonClass} btn-add-cart" data-id="${product.id}">
                  <i class="fas ${inCart ? 'fa-check' : 'fa-cart-plus'}"></i>
                  ${buttonText}
                </button>
                <button class="btn btn-icon" data-id="${product.id}" data-action="details">
                  <i class="fas fa-info"></i>
                </button>
              </div>
            </div>
          </div>`;
      });
      container.innerHTML = html;
      
      // Добавляем делегирование событий
      container.addEventListener('click', function(e) {
        const addToCartBtn = e.target.closest('.btn-add-cart');
        const detailsBtn = e.target.closest('[data-action="details"]');
        
        if (addToCartBtn) {
          const productId = parseInt(addToCartBtn.getAttribute('data-id'));
          addToCart(productId);
        }
        
        if (detailsBtn) {
          const productId = parseInt(detailsBtn.getAttribute('data-id'));
          showProductDetails(productId);
        }
      });
    }

    function filterProducts(category) {
      const productElements = document.querySelectorAll('#products-container .product-card');
      productElements.forEach(product => {
        if (category === 'all' || product.getAttribute('data-category') === category) {
          product.style.display = 'block';
        } else {
          product.style.display = 'none';
        }
      });
    }

    function showProductDetails(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
            <i class="fas fa-times"></i>
          </button>
          
          <h2 class="modal-title">${product.name}</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
            <div style="height: 250px; background: linear-gradient(135deg, ${product.color || '#1a365d'} 0%, ${darkenColor(product.color || '#1a365d', 30)} 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center;">
              <i class="fas ${product.icon || 'fa-cube'}" style="font-size: 100px; color: white;"></i>
            </div>
            
            <div>
              <div style="background: ${product.type === 'standard' ? 'var(--dark-gray)' : product.type === 'premier' ? 'var(--primary)' : 'var(--secondary)'}; color: ${product.type === 'prestige' ? '#000' : 'white'}; padding: 8px 20px; border-radius: 20px; display: inline-block; font-weight: 700; margin-bottom: 15px;">
                ${product.type === 'standard' ? 'Стандарт' : product.type === 'premier' ? 'Премьер' : 'Престиж'}
              </div>
              
              <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 20px;">
                ${formatPrice(product.price)}
              </div>
              
              <div style="margin-bottom: 15px;">
                <strong>Материалы:</strong> ${product.material || 'Не указано'}
              </div>
              
              <div style="margin-bottom: 15px;">
                <strong>Размеры:</strong> ${product.dimensions || 'Не указано'}
              </div>
              
              <div style="margin-bottom: 20px;">
                <strong>Категория:</strong> ${getCategoryName(product.category)}
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 25px;">
            <h3 style="margin-bottom: 10px; color: var(--text-color);">Описание</h3>
            <p style="line-height: 1.6; color: var(--text-secondary);">${product.description || ''}</p>
          </div>
          
          <button class="btn btn-secondary" onclick="addToCart(${product.id}); this.closest('.modal-overlay').remove();" style="width: 100%; padding: 16px;">
            <i class="fas fa-cart-plus"></i>Добавить в корзину
          </button>
        </div>`;
      
      document.body.appendChild(modal);
    }

    function getCategoryName(category) {
      const categories = {
        'table': 'Стол',
        'chair': 'Стул',
        'wardrobe': 'Шкаф',
        'bed': 'Кровать',
        'shelf': 'Полка',
        'kitchen': 'Кухня',
        'sofa': 'Диван',
        'cabinet': 'Тумба',
        'dresser': 'Комод',
        'all': 'Все товары'
      };
      return categories[category] || category;
    }

    // ========== КОРЗИНА ==========
    function toggleCart() {
      document.getElementById('cart-overlay').classList.toggle('active');
      document.getElementById('cart-sidebar').classList.toggle('active');
      updateCartDisplay();
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const existingItem = cart.find(item => item.id === productId);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: product.id,
          quantity: 1
        });
      }
      
      if (localStorageAvailable) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      
      updateCartDisplay();
      updateCartCounter();
      loadCatalog();
      showNotification(`"${product.name}" добавлен в корзину`, 'success');
    }

    function updateCartItem(productId, delta) {
      const itemIndex = cart.findIndex(item => item.id === productId);
      if (itemIndex === -1) return;
      
      cart[itemIndex].quantity += delta;
      if (cart[itemIndex].quantity <= 0) {
        cart.splice(itemIndex, 1);
      }
      
      if (localStorageAvailable) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      
      updateCartDisplay();
      updateCartCounter();
      loadCatalog();
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.id !== productId);
      
      if (localStorageAvailable) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      
      updateCartDisplay();
      updateCartCounter();
      loadCatalog();
      showNotification('Товар удален из корзины', 'info');
    }

    function updateCartDisplay() {
      const container = document.getElementById('cart-content');
      const totalElement = document.getElementById('cart-total');
      const countElement = document.getElementById('cart-count');
      
      if (!cart || cart.length === 0) {
        container.innerHTML = `
          <div class="cart-empty">
            <i class="fas fa-shopping-cart cart-empty-icon"></i>
            <h3>Корзина пуста</h3>
            <p>Добавьте товары из каталога</p>
          </div>
        `;
        totalElement.textContent = '0 ₽';
        if (countElement) countElement.textContent = '0';
        return;
      }
      
      let html = '<div class="cart-items">';
      let total = 0;
      let totalItems = 0;
      
      cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        const itemTotal = product.price * item.quantity;
        total += itemTotal;
        totalItems += item.quantity;
        
        // Безопасное получение цвета
        const color = product.color || '#1a365d';
        const darkColor = darkenColor(color, 30);
        
        html += `
          <div class="cart-item">
            <div class="cart-item-image" style="background: linear-gradient(135deg, ${color} 0%, ${darkColor} 100%);">
              <i class="fas ${product.icon || 'fa-cube'}"></i>
            </div>
            <div class="cart-item-info">
              <h4 class="cart-item-title">${product.name}</h4>
              <div class="cart-item-price">${formatPrice(product.price)}</div>
              <div class="cart-item-actions">
                <div class="quantity-control">
                  <button class="quantity-btn" onclick="updateCartItem(${item.id}, -1)">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span style="font-weight: 600; min-width: 30px; text-align: center;">${item.quantity}</span>
                  <button class="quantity-btn" onclick="updateCartItem(${item.id}, 1)">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <button class="btn btn-icon" onclick="removeFromCart(${item.id})" style="background: #fee; color: var(--danger);">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
      totalElement.textContent = formatPrice(total);
      if (countElement) countElement.textContent = totalItems;
    }

    function updateCartCounter() {
      if (!cart || !Array.isArray(cart)) {
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
          cartCount.textContent = '0';
        }
        return;
      }
      
      const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        cartCount.textContent = totalItems;
      }
    }

    function checkout() {
      if (!cart || cart.length === 0) {
        showNotification('Корзина пуста', 'error');
        return;
      }
      
      if (!currentUser) {
        toggleAuthModal();
        showNotification('Для оформления заказа необходимо авторизоваться', 'info');
        return;
      }
      
      const total = cart.reduce((sum, item) => {
        const product = products.find(p => p.id === item.id);
        return sum + (product ? product.price * item.quantity : 0);
      }, 0);
      
      const order = {
        id: Date.now(),
        userId: currentUser.id,
        userName: currentUser.name,
        items: [...cart],
        total: total,
        status: 'processing',
        date: new Date().toISOString().split('T')[0],
        estimatedDelivery: getDeliveryDate()
      };
      
      orders.push(order);
      if (localStorageAvailable) {
        localStorage.setItem('orders', JSON.stringify(orders));
      }
      
      if (currentUser) {
        currentUser.totalSpent = (currentUser.totalSpent || 0) + total;
        
        if (localStorageAvailable) {
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        if (userIndex !== -1) {
          users[userIndex] = currentUser;
          if (localStorageAvailable) {
            localStorage.setItem('users', JSON.stringify(users));
          }
        }
      }
      
      cart = [];
      if (localStorageAvailable) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      
      toggleCart();
      updateCartDisplay();
      updateCartCounter();
      loadCatalog();
      
      showNotification(`Заказ оформлен на сумму ${formatPrice(total)}!`, 'success');
      
      setTimeout(() => {
        alert(`Заказ №${order.id} оформлен!\n\nСумма: ${formatPrice(total)}\nДата оформления: ${order.date}\nПримерная дата доставки: ${order.estimatedDelivery}\n\nСтатус заказа можно отслеживать в личном кабинете.`);
        if (currentPage === 'profile') {
          updateProfile();
        }
      }, 500);
    }

    // ========== АВТОРИЗАЦИЯ И ПРОФИЛЬ ==========
    function toggleAuthModal() {
      const modal = document.getElementById('auth-modal');
      modal.classList.toggle('active');
      showLoginForm();
    }

    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
    }

    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
    }

    function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        showNotification('Заполните все поля', 'error');
        return;
      }
      
      if (email === 'admin58' && password === '585858') {
        const adminUser = users.find(u => u.role === 'admin') || users[0];
        currentUser = adminUser;
        if (localStorageAvailable) {
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        toggleAuthModal();
        updateUI();
        updateProfile();
        showNotification('Администратор вошел в систему', 'success');
        return;
      }
      
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        currentUser = user;
        if (localStorageAvailable) {
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        toggleAuthModal();
        updateUI();
        updateProfile();
        showNotification('Успешный вход в систему', 'success');
      } else {
        showNotification('Неверный email или пароль', 'error');
      }
    }

    function register() {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      if (!name || !email || !password) {
        showNotification('Заполните все поля', 'error');
        return;
      }
      
      if (users.some(u => u.email === email)) {
        showNotification('Пользователь с таким email уже существует', 'error');
        return;
      }
      
      const newUser = {
        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
        name: name,
        email: email,
        password: password,
        role: 'user',
        totalSpent: 0,
        registrationDate: new Date().toISOString().split('T')[0]
      };
      
      users.push(newUser);
      if (localStorageAvailable) {
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      currentUser = newUser;
      if (localStorageAvailable) {
        localStorage.setItem('currentUser', JSON.stringify(newUser));
      }
      
      toggleAuthModal();
      updateUI();
      updateProfile();
      showNotification('Регистрация прошла успешно!', 'success');
    }

    function logout() {
      currentUser = null;
      if (localStorageAvailable) {
        localStorage.removeItem('currentUser');
      }
      
      updateUI();
      updateProfile();
      showNotification('Вы вышли из системы', 'info');
      
      if (currentPage === 'profile' || currentPage === 'tracking' || currentPage === 'admin') {
        switchPage('home');
      }
    }

    function updateProfile() {
      const profileName = document.getElementById('profile-name');
      const profileEmail = document.getElementById('profile-email');
      const profileAvatar = document.getElementById('profile-avatar');
      const loyaltyCard = document.getElementById('loyalty-card');
      const logoutBtn = document.getElementById('logout-btn');
      const loginProfileBtn = document.getElementById('login-profile-btn');
      const ordersList = document.getElementById('orders-list');
      
      if (currentUser) {
        profileName.textContent = currentUser.name;
        profileEmail.textContent = currentUser.email;
        profileAvatar.innerHTML = currentUser.name.charAt(0);
        
        if (logoutBtn) logoutBtn.style.display = 'block';
        if (loginProfileBtn) loginProfileBtn.style.display = 'none';
        
        if (loyaltyCard) {
          loyaltyCard.classList.remove('hidden');
          updateLoyaltyCard();
        }
        
        if (ordersList) {
          const userOrders = orders.filter(o => o.userId === currentUser.id);
          if (userOrders.length === 0) {
            ordersList.innerHTML = `
              <i class="fas fa-box-open" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
              <p>Заказов пока нет</p>
            `;
          } else {
            let html = '';
            userOrders.slice(0, 5).forEach(order => {
              const statusColor = getStatusColor(order.status);
              html += `
                <div style="background: var(--surface-color); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>Заказ №${order.id}</strong>
                      <div style="font-size: 14px; color: var(--gray);">${order.date}</div>
                    </div>
                    <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                      ${getStatusText(order.status)}
                    </span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>${order.items.length} товар(ов)</div>
                    <div style="font-weight: 700; color: var(--primary);">${formatPrice(order.total)}</div>
                  </div>
                </div>`;
            });
            ordersList.innerHTML = html;
          }
        }
      } else {
        profileName.textContent = 'Гость';
        profileEmail.textContent = 'Для входа нажмите "Войти"';
        profileAvatar.innerHTML = '<i class="fas fa-user"></i>';
        
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (loginProfileBtn) loginProfileBtn.style.display = 'block';
        
        if (loyaltyCard) loyaltyCard.classList.add('hidden');
        
        if (ordersList) {
          ordersList.innerHTML = `
            <i class="fas fa-box-open" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
            <p>Для просмотра истории заказов необходимо авторизоваться</p>
          `;
        }
      }
    }

    function updateLoyaltyCard() {
      if (!currentUser) return;
      
      const totalSpent = currentUser.totalSpent || 0;
      let level = 'bronze';
      let discount = 0;
      let nextLevel = '100 000 ₽';
      let progress = (totalSpent / 100000) * 100;
      
      if (totalSpent >= 500000) {
        level = 'gold';
        discount = 5;
        nextLevel = 'Максимальный уровень';
        progress = 100;
      } else if (totalSpent >= 250000) {
        level = 'silver';
        discount = 2.5;
        nextLevel = '500 000 ₽';
        progress = ((totalSpent - 250000) / 250000) * 100;
      } else if (totalSpent >= 100000) {
        level = 'silver';
        discount = 1;
        nextLevel = '250 000 ₽';
        progress = ((totalSpent - 100000) / 150000) * 100;
      }
      
      const card = document.getElementById('loyalty-card');
      const title = document.getElementById('loyalty-title');
      const progressBar = document.getElementById('loyalty-progress');
      const discountPercent = document.getElementById('discount-percent');
      const nextLevelSpan = document.getElementById('next-level');
      
      if (card && title) {
        title.textContent =
          level === 'gold' ? 'Золотой уровень' :
          level === 'silver' ? 'Серебряный уровень' : 'Бронзовый уровень';
        
        // Установка класса для текстуры
        card.className = 'loyalty-card ' + level;
      }
      
      if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
      if (discountPercent) discountPercent.textContent = discount + '%';
      if (nextLevelSpan) nextLevelSpan.textContent = nextLevel;
    }

    // ========== 3D ПРИМЕРКА ==========
    function initFittingRoom() {
      room3d = {
        length: 4,
        width: 3,
        height: 2.5,
        furniture: [],
        rotation: -15
      };
      updateRoom();
      showRecommendedFurniture();
    }

    function updateSliderValue(sliderId, value) {
      const displayElement = document.getElementById(sliderId.replace('room-', '') + '-value');
      if (displayElement) {
        displayElement.textContent = value + (sliderId.includes('height') ? ' м' : ' м');
      }
    }

    function updateRoom() {
      if (!room3d) return;
      
      room3d.length = parseFloat(document.getElementById('room-length').value);
      room3d.width = parseFloat(document.getElementById('room-width').value);
      room3d.height = parseFloat(document.getElementById('room-height').value);
      
      const container = document.getElementById('room-3d');
      if (!container) return;
      
      const scale = 50;
      const width = room3d.width * scale;
      const length = room3d.length * scale;
      const height = room3d.height * scale;
      
      container.innerHTML = '';
      container.style.width = width + 'px';
      container.style.height = length + 'px';
      container.style.transform = `rotateY(${room3d.rotation}deg)`;
      
      const floor = document.createElement('div');
      floor.className = 'room-walls';
      floor.style.width = width + 'px';
      floor.style.height = length + 'px';
      floor.style.bottom = '0';
      floor.style.left = '0';
      floor.style.background = document.getElementById('floor-color').value || '#8B4513';
      floor.style.transform = `rotateX(90deg) translateZ(${-height/2}px)`;
      container.appendChild(floor);
      
      const walls = [{
          width: width,
          height: height,
          transform: `translateZ(${length/2}px)`
        },
        {
          width: width,
          height: height,
          transform: `rotateY(90deg) translateZ(${width/2}px)`
        },
        {
          width: length,
          height: height,
          transform: `rotateY(-90deg) translateZ(${length/2}px)`
        }
      ];
      
      const wallColor = document.getElementById('wall-color').value || '#f5f5f5';
      
      walls.forEach((wall, index) => {
        const wallElement = document.createElement('div');
        wallElement.className = 'room-walls';
        wallElement.style.width = wall.width + 'px';
        wallElement.style.height = wall.height + 'px';
        wallElement.style.background = wallColor;
        wallElement.style.transform = wall.transform;
        container.appendChild(wallElement);
      });
      
      room3d.furniture.forEach(item => {
        addFurnitureToRoom(item.type, item.x, item.y, item.width, item.height);
      });
    }

    function addSelectedFurniture() {
      if (!selectedFurnitureType || !room3d) return;
      
      const furnitureSizes = {
        'table': { width: 1.2, height: 0.8 },
        'chair': { width: 0.5, height: 0.5 },
        'wardrobe': { width: 0.8, height: 2.0 },
        'bed': { width: 1.6, height: 2.0 },
        'shelf': { width: 0.5, height: 1.5 },
        'kitchen': { width: 2.0, height: 0.6 },
        'sofa': { width: 1.8, height: 0.8 },
        'cabinet': { width: 0.6, height: 0.8 },
        'dresser': { width: 1.0, height: 0.9 }
      };
      
      const size = furnitureSizes[selectedFurnitureType] || { width: 1, height: 1 };
      
      // Проверяем, чтобы мебель помещалась в комнату
      const maxX = room3d.width - size.width;
      const maxY = room3d.length - size.height;
      
      if (maxX <= 0 || maxY <= 0) {
        showNotification('Комната слишком маленькая для этой мебели', 'error');
        return;
      }
      
      const x = Math.random() * maxX;
      const y = Math.random() * maxY;
      
      room3d.furniture.push({
        type: selectedFurnitureType,
        x: x,
        y: y,
        width: size.width,
        height: size.height
      });
      
      updateRoom();
      showNotification(`${getCategoryName(selectedFurnitureType)} добавлен в комнату`, 'success');
    }

    function addFurnitureToRoom(type, x, y, width, height) {
      const container = document.getElementById('room-3d');
      if (!container) return;
      
      const scale = 50;
      const furniture = document.createElement('div');
      furniture.className = 'furniture-item-3d';
      furniture.style.width = width * scale + 'px';
      furniture.style.height = height * scale + 'px';
      furniture.style.left = x * scale + 'px';
      furniture.style.top = y * scale + 'px';
      furniture.innerHTML = `<i class="fas ${getFurnitureIcon(type)}" style="font-size: ${Math.min(width, height) * 20}px; color: var(--secondary);"></i>`;
      
      makeDraggable3D(furniture, type, x, y, width, height);
      container.appendChild(furniture);
    }

    function makeDraggable3D(element, type, x, y, width, height) {
      let isDragging = false;
      let startX, startY;
      
      element.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX - element.offsetLeft;
        startY = e.clientY - element.offsetTop;
        element.style.zIndex = '100';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const scale = 50;
        const newLeft = e.clientX - startX;
        const newTop = e.clientY - startY;
        
        if (newLeft >= 0 && newLeft <= room3d.width * scale - width * scale &&
          newTop >= 0 && newTop <= room3d.length * scale - height * scale) {
          element.style.left = newLeft + 'px';
          element.style.top = newTop + 'px';
          
          const furnitureIndex = room3d.furniture.findIndex(f =>
            f.type === type &&
            Math.abs(f.x * scale - x * scale) < 5 &&
            Math.abs(f.y * scale - y * scale) < 5
          );
          
          if (furnitureIndex !== -1) {
            room3d.furniture[furnitureIndex].x = newLeft / scale;
            room3d.furniture[furnitureIndex].y = newTop / scale;
          }
        }
      });
      
      document.addEventListener('mouseup', function() {
        isDragging = false;
        element.style.zIndex = '10';
      });
    }

    function rotateView(direction) {
      if (!room3d) return;
      
      const container = document.getElementById('room-3d');
      if (!container) return;
      
      room3d.rotation += direction === 'left' ? -15 : 15;
      container.style.transform = `rotateY(${room3d.rotation}deg)`;
    }

    function resetView() {
      if (!room3d) return;
      
      room3d.rotation = -15;
      const container = document.getElementById('room-3d');
      if (container) {
        container.style.transform = `rotateY(${room3d.rotation}deg)`;
      }
    }

    function resetRoom() {
      if (!room3d) return;
      
      room3d.furniture = [];
      updateRoom();
      showNotification('Комната сброшена', 'info');
    }

    function getFurnitureIcon(type) {
      const product = products.find(p => p.category === type);
      return product ? product.icon : 'fa-cube';
    }

    function getFurnitureName(type) {
      const product = products.find(p => p.category === type);
      return product ? getCategoryName(product.category) : 'Мебель';
    }

    function showRecommendedFurniture() {
      const container = document.getElementById('recommended-furniture');
      if (!container) return;
      
      const recommendedProducts = products
        .filter(p => p.category === selectedFurnitureType)
        .slice(0, 3);
      
      if (recommendedProducts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray);">Нет рекомендаций для этой категории</p>';
        return;
      }
      
      let html = '';
      recommendedProducts.forEach(product => {
        const color = product.color || '#1a365d';
        const darkColor = darkenColor(color, 30);
        
        html += `
          <div style="background: var(--surface-color); border-radius: var(--radius); padding: 16px; text-align: center; border: 1px solid var(--border-color);">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, ${color} 0%, ${darkColor} 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white;">
              <i class="fas ${product.icon || 'fa-cube'}" style="font-size: 28px;"></i>
            </div>
            <p style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">${product.name}</p>
            <p style="color: var(--primary); font-weight: 700; margin-bottom: 12px;">${formatPrice(product.price)}</p>
            <button class="btn btn-primary" onclick="addToCart(${product.id})" style="width: 100%; padding: 10px; font-size: 14px;">
              <i class="fas fa-cart-plus"></i>В корзину
            </button>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // ========== КОНФИГУРАТОР ==========
    function initConfigurator() {
      configuratorData = {
        step: 1,
        category: '',
        size: '',
        budget: '',
        material: '',
        results: []
      };
      showConfiguratorStep(1);
    }

    function showConfiguratorStep(step) {
      configuratorData.step = step;
      const content = document.getElementById('configurator-content');
      if (!content) return;
      
      for (let i = 1; i <= 5; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
          stepElement.classList.remove('active', 'completed');
          if (i === step) {
            stepElement.classList.add('active');
          } else if (i < step) {
            stepElement.classList.add('completed');
          }
        }
      }
      
      const prevBtn = document.getElementById('prev-step');
      const nextBtn = document.getElementById('next-step');
      prevBtn.style.display = step > 1 ? 'block' : 'none';
      nextBtn.innerHTML = step === 5 ? 'Завершить<i class="fas fa-check"></i>' : 'Далее<i class="fas fa-arrow-right"></i>';
      nextBtn.onclick = step === 5 ? finishConfigurator : nextStep;
      
      let html = '';
      
      switch (step) {
        case 1:
          html = `
            <div class="step-content">
              <h3 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">Какой тип мебели вас интересует?</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="config-option ${configuratorData.category === 'table' ? 'selected' : ''}" onclick="selectConfigOption('category', 'table')">
                  <i class="fas fa-table" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Столы</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Обеденные, рабочие, журнальные</p>
                </div>
                <div class="config-option ${configuratorData.category === 'chair' ? 'selected' : ''}" onclick="selectConfigOption('category', 'chair')">
                  <i class="fas fa-chair" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Стулья</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Офисные, обеденные, барные</p>
                </div>
                <div class="config-option ${configuratorData.category === 'wardrobe' ? 'selected' : ''}" onclick="selectConfigOption('category', 'wardrobe')">
                  <i class="fas fa-archive" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Шкафы</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Купе, гардеробные, книжные</p>
                </div>
                <div class="config-option ${configuratorData.category === 'bed' ? 'selected' : ''}" onclick="selectConfigOption('category', 'bed')">
                  <i class="fas fa-bed" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Кровати</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Односпальные, двуспальные</p>
                </div>
                <div class="config-option ${configuratorData.category === 'shelf' ? 'selected' : ''}" onclick="selectConfigOption('category', 'shelf')">
                  <i class="fas fa-border-all" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Полки</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Настенные, напольные, модульные</p>
                </div>
                <div class="config-option ${configuratorData.category === 'kitchen' ? 'selected' : ''}" onclick="selectConfigOption('category', 'kitchen')">
                  <i class="fas fa-utensils" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Кухни</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Линейные, угловые, островные</p>
                </div>
              </div>
            </div>`;
          break;
        case 2:
          html = `
            <div class="step-content">
              <h3 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">Какой размер вам нужен?</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="config-option ${configuratorData.size === 'small' ? 'selected' : ''}" onclick="selectConfigOption('size', 'small')">
                  <i class="fas fa-compress-arrows-alt" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Компактный</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Для небольших помещений</p>
                </div>
                <div class="config-option ${configuratorData.size === 'medium' ? 'selected' : ''}" onclick="selectConfigOption('size', 'medium')">
                  <i class="fas fa-arrows-alt-h" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Средний</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Стандартные размеры</p>
                </div>
                <div class="config-option ${configuratorData.size === 'large' ? 'selected' : ''}" onclick="selectConfigOption('size', 'large')">
                  <i class="fas fa-expand-arrows-alt" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                  <h4>Большой</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Для просторных комнат</p>
                </div>
              </div>
            </div>`;
          break;
        case 3:
          html = `
            <div class="step-content">
              <h3 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">Какой материал предпочитаете?</h3>
              <div class="material-selection" style="grid-template-columns: repeat(3, 1fr);">
                <div class="material-option ${configuratorData.material === 'Дерево' ? 'selected' : ''}" onclick="selectConfigOption('material', 'Дерево')">
                  <i class="fas fa-tree" style="font-size: 36px; color: var(--primary); margin-bottom: 10px;"></i>
                  <h4>Дерево</h4>
                  <p style="font-size: 12px; color: var(--text-secondary);">Натуральное дерево</p>
                </div>
                <div class="material-option ${configuratorData.material === 'Металл' ? 'selected' : ''}" onclick="selectConfigOption('material', 'Металл')">
                  <i class="fas fa-cog" style="font-size: 36px; color: var(--primary); margin-bottom: 10px;"></i>
                  <h4>Металл</h4>
                  <p style="font-size: 12px; color: var(--text-secondary);">Сталь, алюминий</p>
                </div>
                <div class="material-option ${configuratorData.material === 'Стекло' ? 'selected' : ''}" onclick="selectConfigOption('material', 'Стекло')">
                  <i class="fas fa-glass-whiskey" style="font-size: 36px; color: var(--primary); margin-bottom: 10px;"></i>
                  <h4>Стекло</h4>
                  <p style="font-size: 12px; color: var(--text-secondary);">Закаленное стекло</p>
                </div>
                <div class="material-option ${configuratorData.material === 'Пластик' ? 'selected' : ''}" onclick="selectConfigOption('material', 'Пластик')">
                  <i class="fas fa-vial" style="font-size: 36px; color: var(--primary); margin-bottom: 10px;"></i>
                  <h4>Пластик</h4>
                  <p style="font-size: 12px; color: var(--text-secondary);">Высококачественный</p>
                </div>
                <div class="material-option ${configuratorData.material === 'Комбинированный' ? 'selected' : ''}" onclick="selectConfigOption('material', 'Комбинированный')">
                  <i class="fas fa-th" style="font-size: 36px; color: var(--primary); margin-bottom: 10px;"></i>
                  <h4>Комбинированный</h4>
                  <p style="font-size: 12px; color: var(--text-secondary);">Сочетание материалов</p>
                </div>
              </div>
            </div>`;
          break;
        case 4:
          html = `
            <div class="step-content">
              <h3 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">Какой бюджет вы рассматриваете?</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="config-option ${configuratorData.budget === 'economy' ? 'selected' : ''}" onclick="selectConfigOption('budget', 'economy')">
                  <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 15px;">до 20 000 ₽</div>
                  <h4>Эконом</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Бюджетные варианты</p>
                </div>
                <div class="config-option ${configuratorData.budget === 'standard' ? 'selected' : ''}" onclick="selectConfigOption('budget', 'standard')">
                  <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 15px;">20-50 000 ₽</div>
                  <h4>Стандарт</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Оптимальное соотношение</p>
                </div>
                <div class="config-option ${configuratorData.budget === 'premium' ? 'selected' : ''}" onclick="selectConfigOption('budget', 'premium')">
                  <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 15px;">от 50 000 ₽</div>
                  <h4>Премиум</h4>
                  <p style="font-size: 14px; color: var(--text-secondary);">Высокое качество</p>
                </div>
              </div>
            </div>`;
          break;
        case 5:
          const results = getConfiguratorResults();
          configuratorData.results = results;
          
          html = `
            <div class="step-content">
              <h3 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">Подходящие варианты для вас</h3>`;
          
          if (results.length === 0) {
            html += `
              <div style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-search" style="font-size: 60px; color: var(--gray); opacity: 0.5; margin-bottom: 20px;"></i>
                <h4 style="color: var(--text-color); margin-bottom: 15px;">Не найдено точных совпадений</h4>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">Вот несколько рекомендуемых товаров:</p>
              </div>`;
            
            // Показываем рекомендуемые товары из выбранной категории или все товары
            const fallbackProducts = configuratorData.category ? 
              products.filter(p => p.category === configuratorData.category).slice(0, 3) : 
              products.slice(0, 3);
              
            results.push(...fallbackProducts);
          }
          
          if (results.length > 0) {
            html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">`;
            
            results.slice(0, 3).forEach(product => {
              // Безопасное получение цвета
              const color = product.color || '#1a365d';
              const darkColor = darkenColor(color, 30);
              
              html += `
                <div class="card" style="text-align: center;">
                  <div style="width: 80px; height: 80px; background: linear-gradient(135deg, ${color} 0%, ${darkColor} 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white;">
                    <i class="fas ${product.icon || 'fa-cube'}" style="font-size: 40px;"></i>
                  </div>
                  <h4 style="margin-bottom: 10px;">${product.name}</h4>
                  <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">${product.material || 'Не указано'}</p>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 15px;">
                    ${formatPrice(product.price)}
                  </div>
                  <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="addToCart(${product.id})" style="flex: 1; padding: 10px;">
                      <i class="fas fa-cart-plus"></i>
                    </button>
                    <button class="btn btn-outline" onclick="switchPage('catalog')" style="flex: 1; padding: 10px;">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </div>`;
            });
            
            html += `</div>`;
          }
          
          html += `</div>`;
          break;
      }
      
      content.innerHTML = html;
    }

    function selectConfigOption(type, value) {
      configuratorData[type] = value;
      showConfiguratorStep(configuratorData.step);
    }

    function nextStep() {
      if (configuratorData.step < 5) {
        let isValid = false;
        switch (configuratorData.step) {
          case 1:
            isValid = configuratorData.category !== '';
            break;
          case 2:
            isValid = configuratorData.size !== '';
            break;
          case 3:
            isValid = configuratorData.material !== '';
            break;
          case 4:
            isValid = configuratorData.budget !== '';
            break;
        }
        
        if (isValid) {
          showConfiguratorStep(configuratorData.step + 1);
        } else {
          showNotification('Пожалуйста, сделайте выбор на текущем шаге', 'error');
        }
      }
    }

    function prevStep() {
      if (configuratorData.step > 1) {
        showConfiguratorStep(configuratorData.step - 1);
      }
    }

    function finishConfigurator() {
      if (configuratorData.results.length > 0) {
        showNotification('Найдено ' + configuratorData.results.length + ' подходящих товаров!', 'success');
        switchPage('catalog');
      } else {
        showNotification('Попробуйте изменить критерии поиска', 'info');
      }
    }

    function getConfiguratorResults() {
      let filteredProducts = [...products];
      
      if (configuratorData.category) {
        filteredProducts = filteredProducts.filter(p => p.category === configuratorData.category);
      }
      
      if (configuratorData.material) {
        filteredProducts = filteredProducts.filter(p => {
          if (!p.material) return false;
          return p.material.toLowerCase().includes(configuratorData.material.toLowerCase());
        });
      }
      
      if (configuratorData.budget) {
        if (configuratorData.budget === 'economy') {
          filteredProducts = filteredProducts.filter(p => p.price < 20000);
        } else if (configuratorData.budget === 'standard') {
          filteredProducts = filteredProducts.filter(p => p.price >= 20000 && p.price <= 50000);
        } else if (configuratorData.budget === 'premium') {
          filteredProducts = filteredProducts.filter(p => p.price > 50000);
        }
      }
      
      return filteredProducts.slice(0, 3);
    }

    // ========== ОТЗЫВЫ ==========
    function loadReviews() {
      const container = document.getElementById('reviews-list');
      if (!container) return;
      
      let html = '';
      reviews.forEach(review => {
        const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
        const date = new Date(review.date).toLocaleDateString('ru-RU');
        
        html += `
          <div class="review-card">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                ${review.userName.charAt(0)}
              </div>
              <div>
                <h4 style="margin-bottom: 5px; color: var(--text-color);">${review.userName}</h4>
                <p style="font-size: 14px; color: var(--gray);">${date}</p>
              </div>
            </div>
            <div class="stars">${stars}</div>
            <p style="line-height: 1.6; color: var(--text-secondary);">${review.text}</p>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    function showReviewModal() {
      if (!currentUser) {
        toggleAuthModal();
        showNotification('Для добавления отзыва необходимо авторизоваться', 'info');
        return;
      }
      
      document.getElementById('review-modal').classList.add('active');
    }

    function closeReviewModal() {
      document.getElementById('review-modal').classList.remove('active');
      document.getElementById('review-text').value = '';
      setRating(5);
    }

    function setRating(rating) {
      document.getElementById('review-rating').value = rating;
      const stars = document.querySelectorAll('#rating-stars i');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#fbbf24';
        } else {
          star.style.color = '#ddd';
        }
      });
    }

    function submitReview() {
      if (!currentUser) return;
      
      const rating = parseInt(document.getElementById('review-rating').value);
      const text = document.getElementById('review-text').value.trim();
      
      if (!text) {
        showNotification('Введите текст отзыва', 'error');
        return;
      }
      
      if (text.length < 10) {
        showNotification('Отзыв должен содержать не менее 10 символов', 'error');
        return;
      }
      
      const newReview = {
        id: reviews.length > 0 ? Math.max(...reviews.map(r => r.id)) + 1 : 1,
        userId: currentUser.id,
        userName: currentUser.name,
        rating: rating,
        text: text,
        date: new Date().toISOString().split('T')[0]
      };
      
      reviews.unshift(newReview);
      if (localStorageAvailable) {
        localStorage.setItem('reviews', JSON.stringify(reviews));
      }
      
      closeReviewModal();
      loadReviews();
      showNotification('Отзыв успешно опубликован!', 'success');
    }

    // ========== КАРТА ==========
    function initMap() {
      const mapElement = document.getElementById('map');
      if (!mapElement || mapElement._leaflet_id) return;
      
      try {
        const map = L.map('map').setView([55.7558, 37.6173], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
        
        L.marker([55.7558, 37.6173])
          .addTo(map)
          .bindPopup(`
            <strong>Удобство 58</strong><br>
            ул. Мебельная, д. 58<br>
            Москва, Россия<br>
            <a href="tel:+78005555858">+7 (800) 555-58-58</a>
          `)
          .openPopup();
      } catch (error) {
        console.log('Карта не загружена:', error);
        mapElement.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--gray);">Карта временно недоступна</p>';
      }
    }

    // ========== АДМИН ПАНЕЛЬ ==========
    function initAdminPanel() {
      showAdminTab('products');
    }

    function showAdminTab(tabName) {
      const content = document.getElementById('admin-content');
      if (!content) return;
      
      switch (tabName) {
        case 'products':
          content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="color: var(--text-color);">Управление товарами</h3>
              <button class="btn btn-secondary" onclick="showAdminProductModal()">
                <i class="fas fa-plus"></i>Добавить товар
              </button>
            </div>
            <div id="admin-products-list">
              <!-- Список товаров -->
            </div>`;
          loadAdminProducts();
          break;
        case 'orders':
          content.innerHTML = `
            <h3 style="color: var(--text-color); margin-bottom: 20px;">Управление заказами</h3>
            <div id="admin-orders-list">
              <!-- Список заказов -->
            </div>`;
          loadAdminOrders();
          break;
        case 'reviews-admin':
          content.innerHTML = `
            <h3 style="color: var(--text-color); margin-bottom: 20px;">Управление отзывами</h3>
            <div id="admin-reviews-list">
              <!-- Список отзывов -->
            </div>`;
          loadAdminReviews();
          break;
        case 'users':
          content.innerHTML = `
            <h3 style="color: var(--text-color); margin-bottom: 20px;">Пользователи</h3>
            <div id="admin-users-list">
              <!-- Список пользователей -->
            </div>`;
          loadAdminUsers();
          break;
      }
    }

    function loadAdminProducts() {
      const container = document.getElementById('admin-products-list');
      if (!container) return;
      
      if (products.length === 0) {
        container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">Товары не найдены</p>';
        return;
      }
      
      let html = '<div style="display: grid; gap: 15px;">';
      products.forEach(product => {
        const badgeColor = product.type === 'standard' ? 'var(--dark-gray)' : product.type === 'premier' ? 'var(--primary)' : 'var(--secondary)';
        // Безопасное получение цвета
        const color = product.color || '#1a365d';
        const darkColor = darkenColor(color, 30);
        
        html += `
          <div style="background: var(--surface-color); border-radius: var(--radius); padding: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, ${color} 0%, ${darkColor} 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white;">
                <i class="fas ${product.icon || 'fa-cube'}"></i>
              </div>
              <div>
                <h4 style="margin-bottom: 5px; color: var(--text-color);">${product.name}</h4>
                <div style="display: flex; gap: 10px; font-size: 14px;">
                  <span style="background: ${badgeColor}; color: ${product.type === 'prestige' ? '#000' : 'white'}; padding: 4px 12px; border-radius: 12px;">
                    ${product.type === 'standard' ? 'Стандарт' : product.type === 'premier' ? 'Премьер' : 'Престиж'}
                  </span>
                  <span style="color: var(--gray);">${product.category}</span>
                  <span style="color: var(--primary); font-weight: 700;">${formatPrice(product.price)}</span>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-icon" onclick="editAdminProduct(${product.id})" style="background: var(--primary); color: white;">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-icon" onclick="deleteAdminProduct(${product.id})" style="background: var(--danger); color: white;">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function editAdminProduct(productId) {
      showNotification('Редактирование товара', 'info');
    }

    function deleteAdminProduct(productId) {
      if (confirm('Вы уверены, что хотите удалить этот товар?')) {
        products = products.filter(p => p.id !== productId);
        if (localStorageAvailable) {
          localStorage.setItem('products', JSON.stringify(products));
        }
        loadAdminProducts();
        showNotification('Товар удален', 'success');
      }
    }

    function loadAdminOrders() {
      const container = document.getElementById('admin-orders-list');
      if (!container) return;
      
      if (orders.length === 0) {
        container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">Заказы не найдены</p>';
        return;
      }
      
      let html = '<div style="display: grid; gap: 15px;">';
      orders.forEach(order => {
        const statusColor = getStatusColor(order.status);
        html += `
          <div style="background: var(--surface-color); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div>
                <h4 style="color: var(--text-color); margin-bottom: 5px;">Заказ №${order.id}</h4>
                <p style="color: var(--gray); font-size: 14px;">${order.userName} • ${order.date}</p>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                  ${getStatusText(order.status)}
                </span>
                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">
                  ${formatPrice(order.total)}
                </div>
              </div>
            </div>
            <div>
              <p style="color: var(--gray); margin-bottom: 10px;">Товары: ${order.items.length} шт.</p>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" onclick="updateOrderStatus(${order.id}, 'processing')" style="padding: 8px 16px; font-size: 14px;">
                  Обработка
                </button>
                <button class="btn btn-outline" onclick="updateOrderStatus(${order.id}, 'delivery')" style="padding: 8px 16px; font-size: 14px;">
                  Доставка
                </button>
                <button class="btn btn-outline" onclick="updateOrderStatus(${order.id}, 'delivered')" style="padding: 8px 16px; font-size: 14px;">
                  Доставлен
                </button>
              </div>
            </div>
          </div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function updateOrderStatus(orderId, status) {
      const orderIndex = orders.findIndex(o => o.id === orderId);
      if (orderIndex !== -1) {
        orders[orderIndex].status = status;
        if (localStorageAvailable) {
          localStorage.setItem('orders', JSON.stringify(orders));
        }
        loadAdminOrders();
        showNotification('Статус заказа обновлен', 'success');
      }
    }

    function loadAdminReviews() {
      const container = document.getElementById('admin-reviews-list');
      if (!container) return;
      
      if (reviews.length === 0) {
        container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">Отзывы не найдены</p>';
        return;
      }
      
      let html = '<div style="display: grid; gap: 15px;">';
      reviews.forEach(review => {
        const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
        html += `
          <div style="background: var(--surface-color); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
              <div>
                <h4 style="color: var(--text-color); margin-bottom: 5px;">${review.userName}</h4>
                <p style="color: var(--gray); font-size: 14px;">${review.date}</p>
              </div>
              <div class="stars" style="font-size: 18px;">${stars}</div>
            </div>
            <p style="color: var(--text-secondary); line-height: 1.6;">${review.text}</p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="btn btn-icon" onclick="deleteAdminReview(${review.id})" style="background: var(--danger); color: white; padding: 8px;">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function deleteAdminReview(reviewId) {
      if (confirm('Вы уверены, что хотите удалить этот отзыв?')) {
        reviews = reviews.filter(r => r.id !== reviewId);
        if (localStorageAvailable) {
          localStorage.setItem('reviews', JSON.stringify(reviews));
        }
        loadAdminReviews();
        showNotification('Отзыв удален', 'success');
      }
    }

    function loadAdminUsers() {
      const container = document.getElementById('admin-users-list');
      if (!container) return;
      
      if (users.length === 0) {
        container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 40px;">Пользователи не найдены</p>';
        return;
      }
      
      let html = '<div style="display: grid; gap: 15px;">';
      users.forEach(user => {
        html += `
          <div style="background: var(--surface-color); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="color: var(--text-color); margin-bottom: 5px;">${user.name}</h4>
                <p style="color: var(--gray); font-size: 14px;">${user.email}</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                  <span style="background: ${user.role === 'admin' ? 'var(--primary)' : 'var(--gray)'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                    ${user.role === 'admin' ? 'Админ' : 'Пользователь'}
                  </span>
                  <span style="color: var(--primary); font-weight: 700;">Потрачено: ${formatPrice(user.totalSpent || 0)}</span>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                ${user.role !== 'admin' ? `
                  <button class="btn btn-icon" onclick="makeAdmin(${user.id})" style="background: var(--primary); color: white; padding: 8px;">
                    <i class="fas fa-user-shield"></i>
                  </button>
                ` : ''}
                ${user.id !== 1 ? `
                  <button class="btn btn-icon" onclick="deleteAdminUser(${user.id})" style="background: var(--danger); color: white; padding: 8px;">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : ''}
              </div>
            </div>
          </div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function makeAdmin(userId) {
      if (confirm('Вы уверены, что хотите сделать этого пользователя администратором?')) {
        const userIndex = users.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          users[userIndex].role = 'admin';
          if (localStorageAvailable) {
            localStorage.setItem('users', JSON.stringify(users));
          }
          loadAdminUsers();
          showNotification('Пользователь стал администратором', 'success');
        }
      }
    }

    function deleteAdminUser(userId) {
      if (userId === 1) {
        showNotification('Нельзя удалить главного администратора', 'error');
        return;
      }
      
      if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
        users = users.filter(u => u.id !== userId);
        if (localStorageAvailable) {
          localStorage.setItem('users', JSON.stringify(users));
        }
        loadAdminUsers();
        showNotification('Пользователь удален', 'success');
      }
    }

    // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
    function getDefaultUsers() {
      return [{
        id: 1,
        name: "Администратор",
        email: "admin58",
        password: "585858",
        role: "admin",
        totalSpent: 0,
        registrationDate: "2024-01-01"
      }];
    }

    function getDefaultProducts() {
      return [
        // Столы (5 товаров)
        {
          id: 1,
          name: "Стол обеденный 'Дуб Премиум'",
          category: "table",
          type: "premier",
          price: 35999,
          material: "Массив дуба, сталь (Премьер: Итальянская сталь, немецкая фурнитура)",
          dimensions: "150×90×75 см",
          description: "Классический обеденный стол из массива дуба на 6 персон с металлическими ножками",
          icon: "fa-table",
          color: "#8B4513"
        },
        {
          id: 2,
          name: "Стол компьютерный 'Профи'",
          category: "table",
          type: "standard",
          price: 18999,
          material: "ЛДСП, металл (Стандарт: Российское ЛДСП, отечественная фурнитура)",
          dimensions: "140×70×75 см",
          description: "Эргономичный компьютерный стол с регулируемой высотой и кабель-менеджментом",
          icon: "fa-table",
          color: "#718096"
        },
        {
          id: 3,
          name: "Стол журнальный 'Минимал'",
          category: "table",
          type: "premier",
          price: 12999,
          material: "Стекло, сталь (Премьер: Закаленное стекло, итальянская сталь)",
          dimensions: "80×50×45 см",
          description: "Современный журнальный стол из закаленного стекла и хромированной стали",
          icon: "fa-table",
          color: "#2d3748"
        },
        {
          id: 4,
          name: "Стол письменный 'Классик'",
          category: "table",
          type: "prestige",
          price: 45999,
          material: "Массив ореха, кожа (Престиж: Отборный орех, итальянская кожа)",
          dimensions: "160×80×75 см",
          description: "Роскошный письменный стол из массива ореха с кожаной столешницей",
          icon: "fa-table",
          color: "#5C4033"
        },
        {
          id: 5,
          name: "Стол барный 'Лофт'",
          category: "table",
          type: "premier",
          price: 24999,
          material: "Металл, дерево (Премьер: Состаренное дерево, кованый металл)",
          dimensions: "120×60×110 см",
          description: "Стильный барный стол в индустриальном стиле для кухни и гостиной",
          icon: "fa-table",
          color: "#4a5568"
        },

        // Стулья (5 товаров)
        {
          id: 6,
          name: "Стул офисный 'Эрго Про'",
          category: "chair",
          type: "premier",
          price: 12999,
          material: "Экокожа, металл (Премьер: Немецкая экокожа, итальянский механизм)",
          dimensions: "55×55×85 см",
          description: "Эргономичный офисный стул с поддержкой поясницы и регулировкой высоты",
          icon: "fa-chair",
          color: "#1a365d"
        },
        {
          id: 7,
          name: "Стул барный 'Модерн'",
          category: "chair",
          type: "standard",
          price: 7999,
          material: "Металл, пластик (Стандарт: Отечественный пластик, российский металл)",
          dimensions: "45×45×95 см",
          description: "Стильный барный стул для кухни и гостиной с регулировкой высоты",
          icon: "fa-chair",
          color: "#4a5568"
        },
        {
          id: 8,
          name: "Стул обеденный 'Венский'",
          category: "chair",
          type: "premier",
          price: 8999,
          material: "Гнутая фанера, сталь (Премьер: Австрийская фанера, немецкая сталь)",
          dimensions: "42×42×85 см",
          description: "Классический венский стул с гнутой спинкой и металлическим каркасом",
          icon: "fa-chair",
          color: "#805ad5"
        },
        {
          id: 9,
          name: "Кресло компьютерное 'Геймер'",
          category: "chair",
          type: "prestige",
          price: 29999,
          material: "Кожа, металл (Престиж: Натуральная кожа, карбоновые элементы)",
          dimensions: "70×70×130 см",
          description: "Профессиональное геймерское кресло с подсветкой и полной эргономикой",
          icon: "fa-chair",
          color: "#2d3748"
        },
        {
          id: 10,
          name: "Стул детский 'Растущий'",
          category: "chair",
          type: "standard",
          price: 5999,
          material: "Пластик, металл (Стандарт: Безопасный пластик, регулируемый механизм)",
          dimensions: "40×40×75 см",
          description: "Детский стул с регулировкой высоты и глубины сиденья",
          icon: "fa-chair",
          color: "#4299e1"
        },

        // Шкафы (5 товаров)
        {
          id: 11,
          name: "Шкаф-купе 'Минимал'",
          category: "wardrobe",
          type: "prestige",
          price: 58999,
          material: "ЛДСП, зеркало, алюминий (Престиж: Австрийское ЛДСП, итальянская фурнитура)",
          dimensions: "200×60×220 см",
          description: "Вместительный шкаф-купе с зеркальными дверями и подсветкой",
          icon: "fa-archive",
          color: "#2d3748"
        },
        {
          id: 12,
          name: "Комод 'Классик'",
          category: "wardrobe",
          type: "premier",
          price: 28999,
          material: "Массив сосны (Премьер: Отборная сосна, немецкие направляющие)",
          dimensions: "100×45×85 см",
          description: "Классический комод с 4 выдвижными ящиками",
          icon: "fa-archive",
          color: "#8B4513"
        },
        {
          id: 13,
          name: "Шкаф книжный 'Библио'",
          category: "wardrobe",
          type: "standard",
          price: 18999,
          material: "ЛДСП, стекло (Стандарт: Российское ЛДСП, закаленное стекло)",
          dimensions: "180×35×200 см",
          description: "Книжный шкаф с стеклянными дверцами и регулируемыми полками",
          icon: "fa-archive",
          color: "#718096"
        },
        {
          id: 14,
          name: "Гардеробная система 'Премиум'",
          category: "wardrobe",
          type: "prestige",
          price: 89999,
          material: "МДФ, металл, стекло (Престиж: Немецкий МДФ, австрийская фурнитура)",
          dimensions: "300×60×220 см",
          description: "Полноценная гардеробная система с различными секциями",
          icon: "fa-archive",
          color: "#1a365d"
        },
        {
          id: 15,
          name: "Шкаф для прихожей 'Холл'",
          category: "wardrobe",
          type: "premier",
          price: 34999,
          material: "МДФ, зеркало (Премьер: Итальянское МДФ, немецкое зеркало)",
          dimensions: "120×40×200 см",
          description: "Узкий шкаф для прихожей с зеркалом и крючками для одежды",
          icon: "fa-archive",
          color: "#4a5568"
        },

        // Кровати (5 товаров)
        {
          id: 16,
          name: "Кровать двуспальная 'Орто Комфорт'",
          category: "bed",
          type: "premier",
          price: 45999,
          material: "Массив ореха, ткань (Премьер: Отборный орех, бельгийская ткань)",
          dimensions: "200×160×110 см",
          description: "Кровать с ортопедическим основанием, ящиками для белья и мягким изголовьем",
          icon: "fa-bed",
          color: "#c19a6b"
        },
        {
          id: 17,
          name: "Кровать односпальная 'Юниор'",
          category: "bed",
          type: "standard",
          price: 23999,
          material: "ЛДСП, металл (Стандарт: Российское ЛДСП, ортопедическое основание)",
          dimensions: "200×90×100 см",
          description: "Односпальная кровать для подростков с ортопедическим основанием",
          icon: "fa-bed",
          color: "#4299e1"
        },
        {
          id: 18,
          name: "Кровать с подъемным механизмом 'Смарт'",
          category: "bed",
          type: "premier",
          price: 38999,
          material: "МДФ, механизм (Премьер: Немецкий МДФ, австрийский механизм)",
          dimensions: "200×160×110 см",
          description: "Кровать с подъемным механизмом для дополнительного хранения",
          icon: "fa-bed",
          color: "#4a5568"
        },
        {
          id: 19,
          name: "Кровать круглая 'Небесная'",
          category: "bed",
          type: "prestige",
          price: 78999,
          material: "Ротанг, текстиль (Престиж: Индонезийский ротанг, итальянский текстиль)",
          dimensions: "220×220×120 см",
          description: "Роскошная круглая кровать с балдахином и подсветкой",
          icon: "fa-bed",
          color: "#805ad5"
        },
        {
          id: 20,
          name: "Кровать двухъярусная 'Детская'",
          category: "bed",
          type: "standard",
          price: 32999,
          material: "Массив, металл (Стандарт: Отечественный массив, безопасные перила)",
          dimensions: "200×90×180 см",
          description: "Безопасная двухъярусная кровать для детей с лестницей и перилами",
          icon: "fa-bed",
          color: "#38a169"
        },

        // Полки (5 товаров)
        {
          id: 21,
          name: "Полка настенная 'Фьюжн'",
          category: "shelf",
          type: "premier",
          price: 15999,
          material: "Стекло, сталь (Премьер: Закаленное стекло, хромированная сталь)",
          dimensions: "120×30×15 см",
          description: "Дизайнерская настенная полка из закаленного стекла и хромированной стали",
          icon: "fa-border-all",
          color: "#1a365d"
        },
        {
          id: 22,
          name: "Стеллаж напольный 'Модуль'",
          category: "shelf",
          type: "standard",
          price: 12999,
          material: "ЛДСП, металл (Стандарт: Российское ЛДСП, регулируемые полки)",
          dimensions: "180×40×200 см",
          description: "Модульный стеллаж с регулируемыми полками",
          icon: "fa-border-all",
          color: "#718096"
        },
        {
          id: 23,
          name: "Полка угловая 'Эконом'",
          category: "shelf",
          type: "standard",
          price: 4999,
          material: "ЛДСП (Стандарт: Отечественное ЛДСП, простая сборка)",
          dimensions: "80×80×30 см",
          description: "Угловая полка для экономии пространства",
          icon: "fa-border-all",
          color: "#4a5568"
        },
        {
          id: 24,
          name: "Стеллаж книжный 'Библиотека'",
          category: "shelf",
          type: "premier",
          price: 28999,
          material: "Массив дуба (Премьер: Отборный дуб, ручная обработка)",
          dimensions: "200×35×220 см",
          description: "Массивный книжный стеллаж из натурального дуба",
          icon: "fa-border-all",
          color: "#8B4513"
        },
        {
          id: 25,
          name: "Полка для обуви 'Прихожая'",
          category: "shelf",
          type: "standard",
          price: 8999,
          material: "Металл, пластик (Стандарт: Прочный металл, износостойкий пластик)",
          dimensions: "100×30×80 см",
          description: "Компактная полка для обуви с 12 отделениями",
          icon: "fa-border-all",
          color: "#2d3748"
        },

        // Кухни (5 товаров)
        {
          id: 26,
          name: "Кухня 'Милан'",
          category: "kitchen",
          type: "prestige",
          price: 249999,
          material: "МДФ, искусственный камень (Престиж: Итальянский МДФ, кварцевый камень)",
          dimensions: "300×60×220 см",
          description: "Современная кухня с каменной столешницей, подсветкой и встроенной техникой",
          icon: "fa-utensils",
          color: "#2d3748"
        },
        {
          id: 27,
          name: "Кухня 'Сканди'",
          category: "kitchen",
          type: "premier",
          price: 189999,
          material: "Массив, пластик (Премьер: Скандинавский массив, немецкий пластик)",
          dimensions: "250×60×220 см",
          description: "Скандинавская кухня в светлых тонах с деревянными фасадами",
          icon: "fa-utensils",
          color: "#cbd5e0"
        },
        {
          id: 28,
          name: "Кухня 'Лофт'",
          category: "kitchen",
          type: "premier",
          price: 219999,
          material: "Металл, дерево, бетон (Премьер: Кованый металл, состаренное дерево)",
          dimensions: "280×60×220 см",
          description: "Индустриальная кухня в стиле лофт с бетонными столешницами",
          icon: "fa-utensils",
          color: "#4a5568"
        },
        {
          id: 29,
          name: "Кухня 'Классик'",
          category: "kitchen",
          type: "prestige",
          price: 299999,
          material: "Массив, мрамор (Престиж: Отборный массив, итальянский мрамор)",
          dimensions: "320×60×240 см",
          description: "Классическая кухня из массива дерева с мраморными столешницами",
          icon: "fa-utensils",
          color: "#8B4513"
        },
        {
          id: 30,
          name: "Кухня угловая 'Компакт'",
          category: "kitchen",
          type: "standard",
          price: 149999,
          material: "ЛДСП, пластик (Стандарт: Отечественное ЛДСП, практичный пластик)",
          dimensions: "220×60×220 см",
          description: "Угловая кухня для небольших помещений с максимальной функциональностью",
          icon: "fa-utensils",
          color: "#718096"
        },

        // Диваны (5 товаров)
        {
          id: 31,
          name: "Диван 'Стокгольм'",
          category: "sofa",
          type: "premier",
          price: 65999,
          material: "Ткань, дерево (Премьер: Шведская ткань, финское дерево)",
          dimensions: "220×90×85 см",
          description: "Удобный диван с механизмом трансформации в спальное место",
          icon: "fa-couch",
          color: "#1a365d"
        },
        {
          id: 32,
          name: "Диван угловой 'Люкс'",
          category: "sofa",
          type: "prestige",
          price: 89999,
          material: "Кожа, металл (Престиж: Натуральная кожа, хромированный металл)",
          dimensions: "280×160×90 см",
          description: "Роскошный угловой диван с кожаной обивкой и подсветкой",
          icon: "fa-couch",
          color: "#2d3748"
        },
        {
          id: 33,
          name: "Диван компактный 'Мини'",
          category: "sofa",
          type: "standard",
          price: 34999,
          material: "Ткань, дерево (Стандарт: Износостойкая ткань, прочное дерево)",
          dimensions: "180×80×85 см",
          description: "Компактный диван для небольших помещений с механизмом трансформации",
          icon: "fa-couch",
          color: "#718096"
        },
        {
          id: 34,
          name: "Диван-кровать 'Трансформер'",
          category: "sofa",
          type: "premier",
          price: 54999,
          material: "Ткань, металл (Премьер: Бельгийская ткань, немецкий механизм)",
          dimensions: "200×90×85 см",
          description: "Практичный диван-кровать с удобным механизмом трансформации",
          icon: "fa-couch",
          color: "#4a5568"
        },
        {
          id: 35,
          name: "Диван угловой 'Модуль'",
          category: "sofa",
          type: "standard",
          price: 78999,
          material: "Ткань, дерево (Стандарт: Износостойкая ткань, модульная конструкция)",
          dimensions: "320×180×90 см",
          description: "Модульный угловой диван с возможностью перестановки секций",
          icon: "fa-couch",
          color: "#1a365d"
        },

        // Тумбы (5 товаров)
        {
          id: 36,
          name: "Тумба прикроватная 'Ночь'",
          category: "cabinet",
          type: "premier",
          price: 12999,
          material: "Дерево, стекло (Премьер: Массив дерева, закаленное стекло)",
          dimensions: "50×40×55 см",
          description: "Элегантная прикроватная тумба с выдвижным ящиком и полкой",
          icon: "fa-dice-d6",
          color: "#8B4513"
        },
        {
          id: 37,
          name: "Тумба под TV 'Медиа'",
          category: "cabinet",
          type: "standard",
          price: 21999,
          material: "ЛДСП, металл (Стандарт: Отечественное ЛДСП, прочный металл)",
          dimensions: "180×45×60 см",
          description: "Телевизионная тумба с отделениями для медиатехники",
          icon: "fa-dice-d6",
          color: "#2d3748"
        },
        {
          id: 38,
          name: "Тумба под раковину 'Ванная'",
          category: "cabinet",
          type: "standard",
          price: 14999,
          material: "МДФ, пластик (Стандарт: Влагостойкий МДФ, практичный пластик)",
          dimensions: "80×48×60 см",
          description: "Тумба для ванной комнаты с раковиной и двумя ящиками",
          icon: "fa-dice-d6",
          color: "#cbd5e0"
        },
        {
          id: 39,
          name: "Тумба комодная 'Премиум'",
          category: "cabinet",
          type: "prestige",
          price: 32999,
          material: "Массив ореха (Престиж: Отборный орех, итальянская фурнитура)",
          dimensions: "120×40×85 см",
          description: "Роскошная тумба-комод из массива ореха с тремя ящиками",
          icon: "fa-dice-d6",
          color: "#5C4033"
        },

        // Комоды (5 товаров)
        {
          id: 40,
          name: "Комод 4-х ящичный 'Практик'",
          category: "dresser",
          type: "standard",
          price: 18999,
          material: "ЛДСП, металл (Стандарт: Российское ЛДСП, плавные направляющие)",
          dimensions: "100×45×85 см",
          description: "Практичный комод с 4 выдвижными ящиками для хранения белья",
          icon: "fa-archive",
          color: "#4a5568"
        },
        {
          id: 41,
          name: "Комод с зеркалом 'Элегант'",
          category: "dresser",
          type: "premier",
          price: 28999,
          material: "МДФ, зеркало (Премьер: Итальянское МДФ, французское зеркало)",
          dimensions: "120×45×90 см",
          description: "Элегантный комод с большим зеркалом и вместительными ящиками",
          icon: "fa-archive",
          color: "#cbd5e0"
        },
        {
          id: 42,
          name: "Комод 6-ти ящичный 'Премиум'",
          category: "dresser",
          type: "prestige",
          price: 45999,
          material: "Массив ореха (Престиж: Отборный орех, ручная полировка)",
          dimensions: "120×45×90 см",
          description: "Шикарный комод из массива ореха с шестью выдвижными ящиками",
          icon: "fa-archive",
          color: "#5C4033"
        },
        {
          id: 43,
          name: "Комод детский 'Радуга'",
          category: "dresser",
          type: "standard",
          price: 15999,
          material: "ЛДСП, пластик (Стандарт: Безопасное ЛДСП, яркие фасады)",
          dimensions: "90×40×75 см",
          description: "Яркий детский комод с 4 ящиками для хранения игрушек и одежды",
          icon: "fa-archive",
          color: "#4299e1"
        },
        {
          id: 44,
          name: "Комод узкий 'Коридор'",
          category: "dresser",
          type: "premier",
          price: 22999,
          material: "МДФ, металл (Премьер: Итальянское МДФ, скрытые ручки)",
          dimensions: "150×35×85 см",
          description: "Узкий комод для прихожей или коридора с 5 выдвижными ящиками",
          icon: "fa-archive",
          color: "#2d3748"
        }
      ];
    }

    function getDefaultReviews() {
      return [{
          id: 1,
          userId: 2,
          userName: "Анна Петрова",
          rating: 5,
          text: "Заказывали кухню в этом магазине. Отличное качество, все идеально подошло по размерам. Сборщики работали аккуратно и профессионально. Очень довольны результатом!",
          date: "2024-01-15"
        },
        {
          id: 2,
          userId: 3,
          userName: "Сергей Иванов",
          rating: 4,
          text: "Покупал шкаф-купе для спальни. Доставили вовремя, собрали быстро. Единственный минус - небольшие царапины на одной из панелей, но их оперативно заменили. Обслуживание на высоте!",
          date: "2024-02-10"
        },
        {
          id: 3,
          userId: 4,
          userName: "Мария Сидорова",
          rating: 5,
          text: "Диван просто шикарный! Мягкий, удобный, цвет полностью соответствует образцу. Заказывали с доставкой, привезли точно в срок. Рекомендую этот магазин!",
          date: "2024-03-05"
        },
        {
          id: 4,
          userId: 5,
          userName: "Дмитрий Козлов",
          rating: 5,
          text: "Приобрел обеденный стол и 6 стульев. Качество на высшем уровне, сборка точная. Особенно порадовала система доставки - все привезли в назначенное время.",
          date: "2024-03-20"
        },
        {
          id: 5,
          userId: 6,
          userName: "Елена Васнецова",
          rating: 4,
          text: "Кровать просто супер! Ортопедическое основание очень комфортное. Единственное - ждали доставку дольше обещанного, но результат того стоил.",
          date: "2024-04-10"
        },
        {
          id: 6,
          userId: 7,
          userName: "Александр Новиков",
          rating: 5,
          text: "Заказывал офисную мебель для компании. Большой выбор, профессиональные консультанты, гибкая система скидок при оптовом заказе. Буду сотрудничать дальше!",
          date: "2024-05-15"
        }
      ];
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
      }).format(price);
    }

    function darkenColor(color, percent) {
      if (!color || typeof color !== 'string') {
        return '#1a365d';
      }
      
      // Удаляем # если есть
      let hex = color.replace("#", "");
      
      // Если цвет в формате RGB
      if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
      }
      
      if (!/^[0-9A-F]{6}$/i.test(hex)) {
        return '#1a365d';
      }
      
      const num = parseInt(hex, 16);
      if (isNaN(num)) {
        return '#1a365d';
      }
      
      const amt = Math.round(255 * (percent / 100));
      
      // Извлекаем компоненты RGB
      let R = (num >> 16) - amt;
      let G = (num >> 8 & 0x00FF) - amt;
      let B = (num & 0x0000FF) - amt;
      
      // Ограничиваем значения от 0 до 255
      R = R < 0 ? 0 : (R > 255 ? 255 : R);
      G = G < 0 ? 0 : (G > 255 ? 255 : G);
      B = B < 0 ? 0 : (B > 255 ? 255 : B);
      
      // Возвращаем HEX
      return "#" + ((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1).toUpperCase();
    }

    function showNotification(message, type = 'success') {
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 4000);
    }

    function showWelcomeModal() {
      setTimeout(() => {
        if (!currentUser && !localStorageAvailable) {
          if (confirm(
            'Добро пожаловать в магазин "Удобство 58"!\n\n' +
            'Зарегистрируйтесь, чтобы получить:\n' +
            '• Накопительную скидку до 5%\n' +
            '• 3D планировщик комнаты\n' +
            '• Историю заказов и статусы\n' +
            '• Подарки и акции\n\n' +
            'Хотите зарегистрироваться сейчас?'
          )) {
            toggleAuthModal();
            showRegisterForm();
          }
        } else if (!currentUser && localStorageAvailable && !localStorage.getItem('welcomeShown')) {
          if (confirm(
            'Добро пожаловать в магазин "Удобство 58"!\n\n' +
            'Зарегистрируйтесь, чтобы получить:\n' +
            '• Накопительную скидку до 5%\n' +
            '• 3D планировщик комнаты\n' +
            '• Историю заказов и статусы\n' +
            '• Подарки и акции\n\n' +
            'Хотите зарегистрироваться сейчас?'
          )) {
            toggleAuthModal();
            showRegisterForm();
          }
        }
      }, 2000);
    }

    function getDeliveryDate() {
      const date = new Date();
      date.setDate(date.getDate() + Math.floor(Math.random() * 7) + 3);
      return date.toLocaleDateString('ru-RU');
    }

    function getStatusText(status) {
      const statuses = {
        'processing': 'Обработка',
        'assembly': 'На сборке',
        'ready': 'Готов к отправке',
        'delivery': 'В доставке',
        'delivered': 'Доставлен'
      };
      return statuses[status] || status;
    }

    function getStatusColor(status) {
      const colors = {
        'processing': 'var(--info)',
        'assembly': 'var(--warning)',
        'ready': 'var(--success)',
        'delivery': 'var(--primary)',
        'delivered': 'var(--secondary)'
      };
      return colors[status] || 'var(--gray)';
    }

    function loadOrderTracking() {
      const container = document.getElementById('order-tracking');
      if (!container) return;
      
      if (!currentUser) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-shopping-cart" style="font-size: 60px; color: var(--light-gray); margin-bottom: 20px;"></i>
            <h3 style="color: var(--text-color); margin-bottom: 15px;">История заказов</h3>
            <p style="color: var(--gray);">Для просмотра заказов необходимо авторизоваться</p>
          </div>`;
        return;
      }
      
      const userOrders = orders.filter(o => o.userId === currentUser.id);
      if (userOrders.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-box-open" style="font-size: 60px; color: var(--light-gray); margin-bottom: 20px;"></i>
            <h3 style="color: var(--text-color); margin-bottom: 15px;">Заказов пока нет</h3>
            <p style="color: var(--gray);">Перейдите в каталог, чтобы сделать заказ</p>
            <button class="btn btn-secondary" onclick="switchPage('catalog')" style="margin-top: 20px;">
              <i class="fas fa-shopping-cart"></i>Перейти в каталог
            </button>
          </div>`;
        return;
      }
      
      let html = '';
      userOrders.forEach(order => {
        const statusText = getStatusText(order.status);
        const statusColor = getStatusColor(order.status);
        
        html += `
          <div class="card" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h3 style="color: var(--text-color); margin-bottom: 5px;">Заказ №${order.id}</h3>
                <p style="color: var(--gray); font-size: 14px;">${order.date}</p>
              </div>
              <div style="background: ${statusColor}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 600;">
                ${statusText}
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
              <div>
                <p style="color: var(--gray); font-size: 14px;">Сумма заказа</p>
                <p style="color: var(--text-color); font-size: 24px; font-weight: 700;">${formatPrice(order.total)}</p>
              </div>
              <div>
                <p style="color: var(--gray); font-size: 14px;">Дата доставки</p>
                <p style="color: var(--text-color); font-size: 16px;">${order.estimatedDelivery}</p>
              </div>
            </div>
            
            <div>
              <p style="color: var(--gray); font-size: 14px; margin-bottom: 10px;">Товары:</p>
              <ul style="color: var(--text-color); padding-left: 20px;">
                ${order.items.map(item => {
                  const product = products.find(p => p.id === item.id);
                  return `<li>${product ? product.name : 'Товар'} × ${item.quantity}</li>`;
                }).join('')}
              </ul>
            </div>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // Инициализация выбранной мебели в 3D примерке
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        const firstOption = document.querySelector('.furniture-option');
        if (firstOption) {
          firstOption.classList.add('selected');
          selectedFurnitureType = firstOption.getAttribute('data-type');
        }
      }, 100);
    });
  </script>
</body>
</html>
